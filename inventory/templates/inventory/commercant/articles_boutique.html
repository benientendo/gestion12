{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Articles - {{ boutique.nom }}{% endblock %}

{% block content %}
<div class="articles-page">
    <!-- Header fixe -->
    <div class="page-header">
        <div class="container-fluid">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-box text-primary"></i> Articles
                        <span class="text-muted fw-normal d-none d-sm-inline">| {{ boutique.nom }}</span>
                    </h4>
                </div>
                <div class="header-actions d-flex flex-wrap align-items-center gap-2">
                    <!-- Stats compactes -->
                    <div class="stats-badges d-none d-lg-flex gap-2 me-2">
                        <span class="badge bg-primary"><i class="fas fa-box"></i> {{ articles.count }} Total</span>
                        <span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle"></i> {{ articles_stock_bas|default:0 }} Stock bas</span>
                    </div>
                    <!-- Bouton Ajouter en premier sur mobile -->
                    <button type="button" class="btn btn-success btn-sm order-first order-md-last" data-bs-toggle="modal" data-bs-target="#ajouterArticleModal">
                        <i class="fas fa-plus"></i> <span class="d-none d-sm-inline">Ajouter</span>
                    </button>
                    <a href="{% url 'inventory:entrer_boutique' boutique.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Retour</span>
                    </a>
                    <a href="{% url 'inventory:historique_mouvements_stock' boutique.id %}" class="btn btn-outline-info btn-sm d-none d-sm-inline-flex" title="Historique des mouvements de stock">
                        <i class="fas fa-history"></i> <span class="d-none d-md-inline">Historique</span>
                    </a>
                    <a href="{% url 'inventory:generer_pdf_qr_codes' boutique.id %}" class="btn btn-outline-primary btn-sm d-none d-sm-inline-flex" target="_blank">
                        <i class="fas fa-qrcode"></i> <span class="d-none d-md-inline">PDF</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de filtres fixe -->
    <div class="filters-bar">
        <div class="container-fluid">
            <div class="row g-2 align-items-center">
                <div class="col-md-5 col-lg-4">
                    <div class="position-relative">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="form-control form-control-sm search-input" id="searchRealTime" 
                               placeholder="Rechercher un article..." autocomplete="off">
                        
                        <!-- Dropdown des actions rapides -->
                        <div class="search-actions-dropdown" id="searchActionsDropdown" style="display: none;">
                            <div class="search-actions-content">
                                <div class="action-item action-add" id="actionAddArticle" style="display: none;">
                                    <button type="button" class="btn btn-success btn-sm w-100 text-start" 
                                            data-bs-toggle="modal" data-bs-target="#ajouterArticleModal">
                                        <i class="fas fa-plus-circle"></i> 
                                        <strong>Ajouter</strong> "<span id="searchTermDisplay"></span>"
                                    </button>
                                </div>
                                <div class="action-results" id="quickResults">
                                    <div class="action-header">Résultats</div>
                                    <div id="quickResultsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-lg-2">
                    <select class="form-select form-select-sm" id="filterCategorie">
                        <option value="">Toutes catégories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.nom }}">{{ cat.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 col-lg-2">
                    <select class="form-select form-select-sm" id="filterStock">
                        <option value="">Tous stocks</option>
                        <option value="bas">Stock bas</option>
                        <option value="zero">Épuisé</option>
                        <option value="normal">Normal</option>
                    </select>
                </div>
                <div class="col-md-2 col-lg-1">
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="btnResetFilters">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="col-lg-3 d-none d-lg-block text-end">
                    <span class="badge bg-dark" id="resultCount">{{ articles|length }} article(s)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Wrapper du tableau avec header fixe -->
    <div class="table-wrapper">
        {% if articles %}
        <!-- En-tête du tableau FIXE -->
        <div class="table-header">
            <table>
                <thead>
                    <tr>
                        <th class="col-img">Image</th>
                        <th class="col-nom">Article</th>
                        <th class="col-code">Code</th>
                        <th class="col-cat">Catégorie</th>
                        <th class="col-prix">Prix</th>
                        <th class="col-stock">Stock</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
        <!-- Corps du tableau SCROLLABLE -->
        <div class="table-body">
            <table>
                <tbody>
                    {% for article in articles %}
                    <tr data-article-id="{{ article.id }}" 
                        data-article-nom="{{ article.nom }}" 
                        data-article-stock="{{ article.quantite_stock }}" 
                        data-article-prix="{{ article.prix_vente }}">
                        <td class="col-img">
                            {% if article.image %}
                            <img src="{{ article.image.url }}" alt="{{ article.nom }}" class="article-img">
                            {% else %}
                            <div class="article-img-placeholder">
                                <i class="fas fa-image"></i>
                            </div>
                            {% endif %}
                        </td>
                        <td class="col-nom">
                            <div class="article-name">{{ article.nom }}</div>
                            {% if article.description %}
                            <div class="article-desc">{{ article.description|truncatechars:35 }}</div>
                            {% endif %}
                        </td>
                        <td class="col-code"><code class="article-code">{{ article.code }}</code></td>
                        <td class="col-cat">
                            {% if article.categorie %}
                            <span class="badge bg-secondary">{{ article.categorie.nom }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="col-prix fw-semibold">
                            {% if article.devise == 'USD' %}
                            <span class="text-success">$ {{ article.prix_vente|floatformat:2 }}</span>
                            {% else %}
                            {{ article.prix_vente|floatformat:0 }} <small>FC</small>
                            {% endif %}
                        </td>
                        <td class="col-stock">
                            {% if article.quantite_stock <= 0 %}
                            <span class="badge bg-danger">{{ article.quantite_stock }}</span>
                            {% elif article.quantite_stock <= boutique.alerte_stock_bas %}
                            <span class="badge bg-warning text-dark">{{ article.quantite_stock }}</span>
                            {% else %}
                            <span class="badge bg-success">{{ article.quantite_stock }}</span>
                            {% endif %}
                        </td>
                        <td class="col-actions">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                        data-bs-toggle="modal" data-bs-target="#articleModal{{ article.id }}" title="Détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" 
                                        data-bs-toggle="modal" data-bs-target="#ajusterStockModal"
                                        onclick="setArticleForStock({{ article.id }}, '{{ article.nom }}', {{ article.quantite_stock }})" title="Stock">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" 
                                        data-bs-toggle="modal" data-bs-target="#modifierPrixModal"
                                        onclick="setArticleForPrice({{ article.id }}, '{{ article.nom }}', {{ article.prix_vente }}, '{{ article.devise }}')" title="Prix">
                                    <i class="fas fa-tag"></i>
                                </button>
                                <a href="{% url 'inventory:modifier_article_boutique' boutique.id article.id %}" 
                                   class="btn btn-outline-warning btn-sm" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h5>Aucun article</h5>
            <p>Commencez par ajouter votre premier article</p>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#ajouterArticleModal">
                <i class="fas fa-plus"></i> Ajouter un article
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals pour les détails des articles -->
{% for article in articles %}
<div class="modal fade" id="articleModal{{ article.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ article.nom }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        {% if article.image %}
                        <img src="{{ article.image.url }}" alt="{{ article.nom }}" class="img-fluid rounded">
                        {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 200px;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <table class="table table-borderless">
                            <tr>
                                <th>Code:</th>
                                <td><code>{{ article.code }}</code></td>
                            </tr>
                            <tr>
                                <th>Catégorie:</th>
                                <td>{{ article.categorie.nom|default:"Aucune" }}</td>
                            </tr>
                            <tr>
                                <th>Prix de vente:</th>
                                <td><strong>
                                    {% if article.devise == 'USD' %}
                                    $ {{ article.prix_vente|floatformat:2 }}
                                    {% else %}
                                    {{ article.prix_vente|floatformat:0 }} FC
                                    {% endif %}
                                </strong></td>
                            </tr>
                            <tr>
                                <th>Stock:</th>
                                <td>{{ article.quantite_stock }} unités</td>
                            </tr>
                            <tr>
                                <th>QR Code:</th>
                                <td>
                                    {% if article.qr_code %}
                                    <img src="{{ article.qr_code.url }}" alt="QR Code" style="width: 100px; height: 100px;">
                                    {% else %}
                                    <span class="text-muted">Non généré</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                        {% if article.description %}
                        <div class="mt-3">
                            <h6>Description:</h6>
                            <p>{{ article.description }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="#" class="btn btn-primary">Modifier</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal d'ajout rapide d'article -->
<div class="modal fade" id="ajouterArticleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Ajouter un Article (Rapide)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAjoutRapide">
                    {% csrf_token %}
                    <input type="hidden" name="boutique_id" value="{{ boutique.id }}">
                    
                    <div class="row">
                        <!-- Champs essentiels seulement -->
                        <div class="col-md-12 mb-3">
                            <label for="nom" class="form-label"><i class="fas fa-tag"></i> Nom de l'article *</label>
                            <input type="text" class="form-control" id="nom" name="nom" required 
                                   placeholder="Ex: Fanta Orange 1.5L">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="devise" class="form-label"><i class="fas fa-coins"></i> Devise *</label>
                            <select class="form-select" id="devise" name="devise" onchange="updateDeviseLabels()">
                                <option value="CDF" selected>CDF (Franc Congolais)</option>
                                <option value="USD">USD (Dollar US)</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3" id="prixVenteContainer">
                            <label for="prix_vente" class="form-label" id="labelPrixVente"><i class="fas fa-money-bill"></i> Prix de vente <span id="devisePrixVente">(CDF)</span> *</label>
                            <div class="input-group">
                                <span class="input-group-text" id="symbolePrixVente">FC</span>
                                <input type="number" class="form-control" id="prix_vente" name="prix_vente" 
                                       required min="0" step="0.01" placeholder="Ex: 1500">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3" id="prixAchatContainer">
                            <label for="prix_achat" class="form-label" id="labelPrixAchat"><i class="fas fa-shopping-cart"></i> Prix d'achat <span id="devisePrixAchat">(CDF)</span></label>
                            <div class="input-group">
                                <span class="input-group-text" id="symbolePrixAchat">FC</span>
                                <input type="number" class="form-control" id="prix_achat" name="prix_achat" 
                                       min="0" step="0.01" placeholder="Optionnel">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="quantite_stock" class="form-label"><i class="fas fa-boxes"></i> Stock initial *</label>
                            <input type="number" class="form-control" id="quantite_stock" name="quantite_stock" 
                                   required min="0" value="0" placeholder="Ex: 50">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categorie" class="form-label"><i class="fas fa-folder"></i> Catégorie</label>
                        <select class="form-select" id="categorie" name="categorie">
                            <option value="">-- Sélectionner une catégorie --</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.nom }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Optionnel - Vous pourrez la modifier plus tard</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Ajout rapide :</strong> Seuls les champs essentiels sont demandés. 
                        Vous pourrez compléter les détails (description, image, etc.) plus tard.
                    </div>
                    
                    <script>
                    function updateDeviseLabels() {
                        const devise = document.getElementById('devise').value;
                        const isCDF = devise === 'CDF';
                        
                        // Mise à jour des labels de devise
                        document.getElementById('devisePrixVente').textContent = isCDF ? '(CDF)' : '(USD)';
                        document.getElementById('devisePrixAchat').textContent = isCDF ? '(CDF)' : '(USD)';
                        
                        // Mise à jour des symboles
                        document.getElementById('symbolePrixVente').textContent = isCDF ? 'FC' : '$';
                        document.getElementById('symbolePrixAchat').textContent = isCDF ? 'FC' : '$';
                        
                        // Highlight visuel du container
                        const prixVenteContainer = document.getElementById('prixVenteContainer');
                        if (prixVenteContainer) {
                            prixVenteContainer.style.backgroundColor = '#f8fff8';
                            prixVenteContainer.style.border = '2px solid #28a745';
                            prixVenteContainer.style.borderRadius = '8px';
                            prixVenteContainer.style.padding = '10px';
                        }
                    }
                    // Initialiser au chargement
                    document.addEventListener('DOMContentLoaded', updateDeviseLabels);
                    </script>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-success" id="btnAjouterArticle">
                    <i class="fas fa-save"></i> Ajouter l'Article
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajustement Stock Rapide -->
<div class="modal fade" id="ajusterStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-boxes me-2"></i>Ajuster le Stock</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong id="stockArticleName"></strong><br>
                    <small>Stock actuel: <span id="stockActuel" class="badge bg-primary"></span> unités</small>
                </div>
                
                <form id="formAjusterStock">
                    {% csrf_token %}
                    <input type="hidden" id="stockArticleId" name="article_id">
                    
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-cogs"></i> Type d'ajustement</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="type_ajustement" id="ajouterStock" value="ajouter" checked>
                            <label class="btn btn-outline-success" for="ajouterStock">
                                <i class="fas fa-plus"></i> Ajouter
                            </label>
                            
                            <input type="radio" class="btn-check" name="type_ajustement" id="retirerStock" value="retirer">
                            <label class="btn btn-outline-danger" for="retirerStock">
                                <i class="fas fa-minus"></i> Retirer
                            </label>
                            
                            <input type="radio" class="btn-check" name="type_ajustement" id="definirStock" value="definir">
                            <label class="btn btn-outline-info" for="definirStock">
                                <i class="fas fa-edit"></i> Définir
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quantite_ajustement" class="form-label"><i class="fas fa-hashtag"></i> Quantité</label>
                        <input type="number" class="form-control form-control-lg" id="quantite_ajustement" 
                               name="quantite" required min="1" value="1" autofocus>
                    </div>
                    
                    <div class="mb-3">
                        <label for="commentaire_stock" class="form-label"><i class="fas fa-comment"></i> Commentaire (optionnel)</label>
                        <textarea class="form-control" id="commentaire_stock" name="commentaire" rows="2" 
                                  placeholder="Ex: Réception nouvelle commande"></textarea>
                    </div>
                    
                    <div class="alert alert-secondary">
                        <strong>Nouveau stock:</strong> <span id="previewStock" class="text-primary fs-5"></span> unités
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-success" id="btnAjusterStock">
                    <i class="fas fa-check"></i> Confirmer l'Ajustement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modification Prix Rapide -->
<div class="modal fade" id="modifierPrixModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-dollar-sign me-2"></i>Modifier le Prix</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong id="prixArticleName"></strong><br>
                    <small>Prix actuel: <span id="prixActuel" class="badge bg-primary"></span> <span id="prixDeviseActuelle">CDF</span></small>
                </div>
                
                <form id="formModifierPrix">
                    {% csrf_token %}
                    <input type="hidden" id="prixArticleId" name="article_id">
                    <input type="hidden" id="prixArticleDevise" name="devise" value="CDF">
                    
                    <div class="mb-3">
                        <label for="nouveau_prix" class="form-label">
                            <i class="fas fa-money-bill"></i> Nouveau Prix de Vente 
                            <span id="prixDeviseLabel">(CDF)</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text" id="prixDeviseSymbole">FC</span>
                            <input type="number" class="form-control form-control-lg text-center" id="nouveau_prix" 
                                   name="prix_vente" required min="0" step="0.01" autofocus>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="commentaire_prix" class="form-label"><i class="fas fa-comment"></i> Raison du changement (optionnel)</label>
                        <textarea class="form-control" id="commentaire_prix" name="commentaire" rows="2" 
                                  placeholder="Ex: Promotion, Hausse des coûts..."></textarea>
                    </div>
                    
                    <div id="changementPrixInfo" class="alert alert-warning" style="display: none;">
                        <strong>Changement:</strong> <span id="changementPrixText"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-info" id="btnModifierPrix">
                    <i class="fas fa-check"></i> Enregistrer le Prix
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ========== LAYOUT PRINCIPAL - PAGE FIXE ========== */
.articles-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 56px);
    overflow: hidden;
    background: #f8f9fa;
}

/* Header fixe */
.page-header {
    background: #fff;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
}

.page-header h4 {
    font-size: 1.1rem;
    font-weight: 600;
}

.stats-badges .badge {
    font-weight: 500;
    font-size: 0.75rem;
    padding: 6px 10px;
}

/* Barre de filtres fixe */
.filters-bar {
    background: #fff;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
}

.search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 0.85rem;
    z-index: 2;
}

.search-input {
    padding-left: 32px;
    border-radius: 6px;
}

/* ========== STRUCTURE TABLEAU FIXE ========== */
.table-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #fff;
}

/* En-tête du tableau FIXE */
.table-header {
    flex-shrink: 0;
    background: #343a40;
}

.table-header table {
    width: 100%;
    table-layout: fixed;
    margin: 0;
}

.table-header th {
    background: #343a40;
    color: #fff;
    font-weight: 600;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    padding: 12px 10px;
    border: none;
    white-space: nowrap;
}

/* Corps du tableau SCROLLABLE */
.table-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
}

.table-body table {
    width: 100%;
    table-layout: fixed;
    margin: 0;
}

.table-body tbody tr {
    transition: background-color 0.15s ease;
}

.table-body tbody tr:hover {
    background-color: #f1f3f4;
}

.table-body tbody td {
    padding: 10px;
    vertical-align: middle;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.85rem;
}

/* Largeurs des colonnes synchronisées */
.col-img { width: 60px; }
.col-nom { width: auto; }
.col-code { width: 110px; }
.col-cat { width: 120px; }
.col-prix { width: 110px; }
.col-stock { width: 70px; }
.col-actions { width: 140px; }

/* ========== ÉLÉMENTS DU TABLEAU ========== */
.article-img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.article-img-placeholder {
    width: 40px;
    height: 40px;
    background: #f1f3f4;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
    font-size: 0.9rem;
}

.article-name {
    font-weight: 600;
    color: #212529;
    line-height: 1.3;
}

.article-desc {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 2px;
}

.article-code {
    font-size: 0.8rem;
    background: #f1f3f4;
    padding: 3px 6px;
    border-radius: 4px;
    color: #495057;
}

/* ========== BADGES ========== */
.badge {
    font-weight: 500;
    font-size: 0.75rem;
    padding: 4px 8px;
}

/* ========== BOUTONS D'ACTION ========== */
.btn-group-sm .btn {
    padding: 4px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
}

/* ========== ÉTAT VIDE ========== */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.empty-state h5 {
    font-weight: 600;
    margin-bottom: 8px;
}

.empty-state p {
    margin-bottom: 15px;
    font-size: 0.9rem;
}

/* ========== DROPDOWN RECHERCHE ========== */
.search-actions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-top: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.search-actions-content {
    padding: 8px;
}

.action-header {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.7rem;
    text-transform: uppercase;
    padding: 6px 8px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 6px;
}

.action-item {
    margin-bottom: 6px;
}

.quick-result-item {
    padding: 8px;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    margin-bottom: 4px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.15s ease;
}

.quick-result-item:hover {
    background: #e9ecef;
    border-color: #0d6efd;
}

.quick-result-item .result-name {
    font-weight: 600;
    font-size: 0.85rem;
}

.quick-result-item .result-info {
    font-size: 0.75rem;
    color: #6c757d;
}

/* ========== RESPONSIVE ========== */

/* Très petits écrans (< 480px) */
@media (max-width: 480px) {
    .articles-page {
        height: calc(100vh - 50px);
    }
    
    .page-header {
        padding: 8px 0;
    }
    
    .page-header h4 {
        font-size: 0.95rem;
    }
    
    .header-actions {
        width: 100%;
        justify-content: flex-start;
    }
    
    .header-actions .btn {
        padding: 6px 10px;
        font-size: 0.75rem;
    }
    
    .filters-bar {
        padding: 8px 0;
    }
    
    .filters-bar .form-control,
    .filters-bar .form-select {
        font-size: 0.8rem;
    }
    
    /* Tableau en mode carte sur très petit écran */
    .table-header {
        display: none;
    }
    
    .table-body table {
        display: block;
    }
    
    .table-body tbody {
        display: block;
    }
    
    .table-body tbody tr {
        display: flex;
        flex-wrap: wrap;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .table-body tbody td {
        border: none;
        padding: 4px 6px;
    }
    
    .table-body tbody td.col-img {
        width: 50px;
        order: 1;
    }
    
    .table-body tbody td.col-nom {
        width: calc(100% - 60px);
        order: 2;
    }
    
    .table-body tbody td.col-prix {
        width: 50%;
        order: 3;
        font-size: 0.9rem;
    }
    
    .table-body tbody td.col-stock {
        width: 50%;
        order: 4;
        text-align: right;
    }
    
    .table-body tbody td.col-actions {
        width: 100%;
        order: 5;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e9ecef;
    }
    
    .table-body tbody td.col-code,
    .table-body tbody td.col-cat {
        display: none;
    }
    
    .col-actions .btn-group {
        width: 100%;
        display: flex;
    }
    
    .col-actions .btn-group .btn {
        flex: 1;
    }
}

/* Écrans moyens (481px - 768px) */
@media (min-width: 481px) and (max-width: 768px) {
    .page-header h4 {
        font-size: 1rem;
    }
    
    .stats-badges {
        display: none !important;
    }
    
    .table-header th,
    .table-body td {
        padding: 8px 6px;
        font-size: 0.8rem;
    }
    
    .col-code, .col-cat {
        display: none;
    }
    
    .col-img { width: 50px; }
    .col-nom { width: auto; }
    .col-prix { width: 100px; }
    .col-stock { width: 60px; }
    .col-actions { width: 120px; }
}

/* Tablettes (769px - 991px) */
@media (min-width: 769px) and (max-width: 991px) {
    .col-cat {
        display: none;
    }
    
    .col-actions { width: 130px; }
}

/* ========== SCROLLBAR PERSONNALISÉE ========== */
.table-body::-webkit-scrollbar {
    width: 8px;
}

.table-body::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.table-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.table-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnAjouterArticle = document.getElementById('btnAjouterArticle');
    const formAjoutRapide = document.getElementById('formAjoutRapide');
    const modal = document.getElementById('ajouterArticleModal');
    let articlesAjoutes = 0; // Compteur d'articles ajoutés
    
    // Fonction pour soumettre le formulaire
    function soumettreFormulaire() {
        // Validation du formulaire
        if (!formAjoutRapide.checkValidity()) {
            formAjoutRapide.reportValidity();
            return;
        }
        
        // Désactiver le bouton pendant l'envoi
        btnAjouterArticle.disabled = true;
        btnAjouterArticle.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout en cours...';
        
        // Récupérer les données du formulaire
        const formData = new FormData(formAjoutRapide);
        
        // Envoyer en AJAX
        fetch('{% url "inventory:ajouter_article_boutique" boutique.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Supprimer les anciens messages
                const oldAlerts = document.querySelectorAll('#ajouterArticleModal .alert');
                oldAlerts.forEach(alert => alert.remove());
                
                // Afficher un message de succès DANS le modal
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> <strong>Article "${data.article_nom || 'ajouté'}" avec succès !</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('#ajouterArticleModal .modal-body').insertBefore(
                    alertDiv, 
                    formAjoutRapide
                );
                
                // Incrémenter le compteur d'articles ajoutés
                articlesAjoutes++;
                
                // Réinitialiser le formulaire pour ajouter un autre article
                formAjoutRapide.reset();
                
                // Réactiver le bouton
                btnAjouterArticle.disabled = false;
                btnAjouterArticle.innerHTML = '<i class="fas fa-save"></i> Ajouter l\'Article';
                
                // Focus sur le premier champ pour un ajout rapide
                document.getElementById('nom').focus();
                
                // Faire disparaître le message après 3 secondes
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }, 3000);
            } else {
                // Afficher les erreurs
                let errorMessage = 'Erreurs : ';
                if (data.errors) {
                    Object.keys(data.errors).forEach(key => {
                        errorMessage += data.errors[key].join(', ') + ' ';
                    });
                } else {
                    errorMessage = data.message || 'Une erreur est survenue';
                }
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> ${errorMessage}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('#ajouterArticleModal .modal-body').insertBefore(
                    alertDiv, 
                    formAjoutRapide
                );
                
                // Réactiver le bouton
                btnAjouterArticle.disabled = false;
                btnAjouterArticle.innerHTML = '<i class="fas fa-save"></i> Ajouter l\'Article';
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> Une erreur est survenue lors de l'ajout de l'article.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('#ajouterArticleModal .modal-body').insertBefore(
                alertDiv, 
                formAjoutRapide
            );
            
            // Réactiver le bouton
            btnAjouterArticle.disabled = false;
            btnAjouterArticle.innerHTML = '<i class="fas fa-save"></i> Ajouter l\'Article';
        });
    }
    
    // Gestionnaire pour le bouton
    btnAjouterArticle.addEventListener('click', soumettreFormulaire);
    
    // Gestionnaire pour la touche Entrée sur les champs du formulaire
    formAjoutRapide.addEventListener('keypress', function(e) {
        // Vérifier si c'est la touche Entrée et que ce n'est pas un textarea ou select
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
            e.preventDefault(); // Empêcher la soumission normale du formulaire
            soumettreFormulaire();
        }
    });
    
    // Réinitialiser le formulaire quand le modal est fermé
    modal.addEventListener('hidden.bs.modal', function() {
        formAjoutRapide.reset();
        btnAjouterArticle.disabled = false;
        btnAjouterArticle.innerHTML = '<i class="fas fa-save"></i> Ajouter l\'Article';
        
        // Supprimer tous les messages (succès et erreur)
        const alerts = document.querySelectorAll('#ajouterArticleModal .alert');
        alerts.forEach(alert => alert.remove());
        
        // Recharger la page si des articles ont été ajoutés
        if (articlesAjoutes > 0) {
            window.location.reload();
        }
    });
    
    // ==================== RECHERCHE EN TEMPS RÉEL ====================
    const searchInput = document.getElementById('searchRealTime');
    const filterCategorie = document.getElementById('filterCategorie');
    const filterStock = document.getElementById('filterStock');
    const btnResetFilters = document.getElementById('btnResetFilters');
    const resultCount = document.getElementById('resultCount');
    const tableBody = document.querySelector('tbody');
    const searchActionsDropdown = document.getElementById('searchActionsDropdown');
    const actionAddArticle = document.getElementById('actionAddArticle');
    const searchTermDisplay = document.getElementById('searchTermDisplay');
    const quickResultsList = document.getElementById('quickResultsList');
    const quickResults = document.getElementById('quickResults');
    
    // Stocker toutes les lignes du tableau avec leurs données
    let allRows = Array.from(tableBody.querySelectorAll('tr'));
    let allArticles = [];
    
    // Extraire les données des articles depuis les attributs data-*
    allRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0 && row.dataset.articleId) {
            allArticles.push({
                row: row,
                id: row.dataset.articleId,
                nom: row.dataset.articleNom || cells[1]?.textContent.trim() || '',
                code: cells[2]?.textContent.trim() || '',
                categorie: cells[3]?.textContent.trim() || '',
                prix: cells[4]?.textContent.trim() || '',
                stock: parseInt(row.dataset.articleStock) || 0,
                prixNumeric: parseFloat(row.dataset.articlePrix) || 0
            });
        }
    });
    
    // Fonction de filtrage avec debounce pour optimiser les performances
    let debounceTimer;
    function filterArticles() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const categorieFilter = filterCategorie.value.toLowerCase();
            const stockFilter = filterStock.value;
            
            // Gérer l'affichage du dropdown d'actions
            if (searchTerm.length >= 2) {
                showSearchActions(searchTerm);
            } else {
                searchActionsDropdown.style.display = 'none';
            }
            
            let visibleCount = 0;
            let matchedArticles = [];
            
            allRows.forEach(row => {
                // Récupérer les données de la ligne
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;
                
                const nom = cells[0]?.textContent.toLowerCase() || '';
                const code = cells[1]?.textContent.toLowerCase() || '';
                const categorie = cells[2]?.textContent.toLowerCase() || '';
                const stock = parseInt(cells[4]?.textContent.trim()) || 0;
                const prix = cells[3]?.textContent.toLowerCase() || '';
                
                // Appliquer le filtre de recherche textuelle
                const matchSearch = !searchTerm || 
                    nom.includes(searchTerm) || 
                    code.includes(searchTerm) || 
                    categorie.includes(searchTerm) ||
                    prix.includes(searchTerm);
                
                // Appliquer le filtre de catégorie
                const matchCategorie = !categorieFilter || categorie.includes(categorieFilter);
                
                // Appliquer le filtre de stock
                let matchStock = true;
                if (stockFilter === 'bas') {
                    matchStock = stock > 0 && stock < {{ boutique.alerte_stock_bas }};
                } else if (stockFilter === 'zero') {
                    matchStock = stock === 0;
                } else if (stockFilter === 'normal') {
                    matchStock = stock >= {{ boutique.alerte_stock_bas }};
                }
                
                // Afficher ou masquer la ligne
                if (matchSearch && matchCategorie && matchStock) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Mettre à jour le compteur
            resultCount.textContent = `${visibleCount} article(s) trouvé(s)`;
            
            // Afficher un message si aucun résultat
            const noResultRow = tableBody.querySelector('.no-result-row');
            if (visibleCount === 0) {
                if (!noResultRow) {
                    const tr = document.createElement('tr');
                    tr.className = 'no-result-row';
                    tr.innerHTML = `
                        <td colspan="7" class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5>Aucun article trouvé</h5>
                            <p class="text-muted">Essayez de modifier vos critères de recherche</p>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                }
            } else if (noResultRow) {
                noResultRow.remove();
            }
        }, 300); // Délai de 300ms après la dernière frappe
    }
    
    // Événements pour la recherche en temps réel
    searchInput.addEventListener('input', filterArticles);
    filterCategorie.addEventListener('change', filterArticles);
    filterStock.addEventListener('change', filterArticles);
    
    // Bouton de réinitialisation
    btnResetFilters.addEventListener('click', function() {
        searchInput.value = '';
        filterCategorie.value = '';
        filterStock.value = '';
        filterArticles();
        searchInput.focus();
    });
    
    // Effet visuel sur le champ de recherche
    searchInput.addEventListener('focus', function() {
        this.parentElement.classList.add('search-focused');
        if (this.value.trim().length >= 2) {
            searchActionsDropdown.style.display = 'block';
        }
    });
    
    searchInput.addEventListener('blur', function() {
        this.parentElement.classList.remove('search-focused');
        // Délai pour permettre le clic sur les actions
        setTimeout(() => {
            searchActionsDropdown.style.display = 'none';
        }, 200);
    });
    
    // Fonction pour afficher le dropdown d'actions
    function showSearchActions(searchTerm) {
        // Trouver les articles correspondants
        const matches = allArticles.filter(article => {
            return article.nom.toLowerCase().includes(searchTerm) ||
                   article.code.toLowerCase().includes(searchTerm) ||
                   article.categorie.toLowerCase().includes(searchTerm);
        }).slice(0, 5); // Limiter à 5 résultats
        
        // Afficher ou masquer le bouton d'ajout
        if (matches.length === 0) {
            actionAddArticle.style.display = 'block';
            searchTermDisplay.textContent = searchTerm;
            quickResults.style.display = 'none';
        } else {
            actionAddArticle.style.display = 'none';
            quickResults.style.display = 'block';
            
            // Construire la liste des résultats rapides
            quickResultsList.innerHTML = matches.map((article, index) => `
                <div class="quick-result-item">
                    <div class="result-name">${article.nom}</div>
                    <div class="result-info">
                        <span class="badge bg-secondary">${article.code}</span>
                        <span class="badge bg-info">${article.categorie || 'Sans catégorie'}</span>
                        <span class="badge bg-primary">${article.stock} en stock</span>
                        <span class="text-success fw-bold">${article.prix}</span>
                    </div>
                    <div class="result-actions">
                        <button type="button" class="btn btn-success btn-xs quick-action-btn" 
                                data-article-id="${article.id}"
                                data-article-nom="${article.nom.replace(/"/g, '&quot;')}"
                                data-article-stock="${article.stock}"
                                data-action="stock">
                            <i class="fas fa-boxes"></i> Stock
                        </button>
                        <button type="button" class="btn btn-info btn-xs quick-action-btn" 
                                data-article-id="${article.id}"
                                data-article-nom="${article.nom.replace(/"/g, '&quot;')}"
                                data-article-prix="${article.prixNumeric}"
                                data-action="prix">
                            <i class="fas fa-dollar-sign"></i> Prix
                        </button>
                        <a href="/commercant/boutiques/{{ boutique.id }}/articles/${article.id}/modifier/" 
                           class="btn btn-warning btn-xs">
                            <i class="fas fa-edit"></i> Modifier
                        </a>
                    </div>
                </div>
            `).join('');
            
            // Ajouter les event listeners pour les actions rapides
            setTimeout(() => {
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const action = this.getAttribute('data-action');
                        const articleId = this.getAttribute('data-article-id');
                        const articleNom = this.getAttribute('data-article-nom');
                        
                        // Fermer le dropdown
                        searchActionsDropdown.style.display = 'none';
                        
                        if (action === 'stock') {
                            const stock = parseInt(this.getAttribute('data-article-stock'));
                            setArticleForStock(articleId, articleNom, stock);
                            // Ouvrir le modal
                            const modal = new bootstrap.Modal(document.getElementById('ajusterStockModal'));
                            modal.show();
                        } else if (action === 'prix') {
                            const prix = parseFloat(this.getAttribute('data-article-prix'));
                            setArticleForPrice(articleId, articleNom, prix);
                            // Ouvrir le modal
                            const modal = new bootstrap.Modal(document.getElementById('modifierPrixModal'));
                            modal.show();
                        }
                    });
                });
            }, 100);
        }
        
        searchActionsDropdown.style.display = 'block';
    }
    
    // Pré-remplir le formulaire d'ajout avec le terme recherché
    searchActionsDropdown.querySelector('.action-add button')?.addEventListener('click', function() {
        const searchTerm = searchInput.value.trim();
        if (searchTerm) {
            // Pré-remplir le nom de l'article dans le modal
            setTimeout(() => {
                const nomInput = document.getElementById('nom');
                if (nomInput && !nomInput.value) {
                    nomInput.value = searchTerm;
                }
            }, 100);
        }
    });
    
    // ==================== AJUSTEMENT STOCK RAPIDE ====================
    let currentStockArticleId = null;
    let currentStockActuel = 0;
    
    window.setArticleForStock = function(articleId, articleNom, stockActuel) {
        currentStockArticleId = articleId;
        currentStockActuel = stockActuel;
        
        document.getElementById('stockArticleId').value = articleId;
        document.getElementById('stockArticleName').textContent = articleNom;
        document.getElementById('stockActuel').textContent = stockActuel;
        document.getElementById('quantite_ajustement').value = 1;
        document.getElementById('commentaire_stock').value = '';
        document.getElementById('ajouterStock').checked = true;
        
        updateStockPreview();
    };
    
    function updateStockPreview() {
        const typeAjustement = document.querySelector('input[name="type_ajustement"]:checked').value;
        const quantite = parseInt(document.getElementById('quantite_ajustement').value) || 0;
        let nouveauStock = currentStockActuel;
        
        if (typeAjustement === 'ajouter') {
            nouveauStock = currentStockActuel + quantite;
        } else if (typeAjustement === 'retirer') {
            nouveauStock = Math.max(0, currentStockActuel - quantite);
        } else if (typeAjustement === 'definir') {
            nouveauStock = quantite;
        }
        
        document.getElementById('previewStock').textContent = nouveauStock;
    }
    
    // Événements pour mise à jour du preview
    document.querySelectorAll('input[name="type_ajustement"]').forEach(radio => {
        radio.addEventListener('change', updateStockPreview);
    });
    
    document.getElementById('quantite_ajustement').addEventListener('input', updateStockPreview);
    
    // Validation par touche Enter pour le formulaire de stock
    document.getElementById('formAjusterStock').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('btnAjusterStock').click();
        }
    });
    
    // Soumission ajustement stock
    document.getElementById('btnAjusterStock').addEventListener('click', function() {
        const form = document.getElementById('formAjusterStock');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajustement...';
        
        const formData = new FormData(form);
        formData.append('type_ajustement', document.querySelector('input[name="type_ajustement"]:checked').value);
        
        fetch(`/commercant/boutiques/{{ boutique.id }}/articles/${currentStockArticleId}/ajuster-stock/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fermer le modal et recharger
                bootstrap.Modal.getInstance(document.getElementById('ajusterStockModal')).hide();
                location.reload();
            } else {
                alert('Erreur: ' + (data.message || 'Une erreur est survenue'));
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Confirmer l\'Ajustement';
            }
        })
        .catch(error => {
            alert('Erreur réseau: ' + error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Confirmer l\'Ajustement';
        });
    });
    
    // ==================== MODIFICATION PRIX RAPIDE ====================
    let currentPrixArticleId = null;
    let currentPrixActuel = 0;
    
    let currentPrixDevise = 'CDF';
    
    window.setArticleForPrice = function(articleId, articleNom, prixActuel, devise = 'CDF') {
        currentPrixArticleId = articleId;
        currentPrixActuel = prixActuel;
        currentPrixDevise = devise;
        
        const isUSD = devise === 'USD';
        const symbole = isUSD ? '$' : 'FC';
        const deviseText = isUSD ? 'USD' : 'CDF';
        const decimales = isUSD ? 2 : 0;
        
        document.getElementById('prixArticleId').value = articleId;
        document.getElementById('prixArticleDevise').value = devise;
        document.getElementById('prixArticleName').textContent = articleNom;
        document.getElementById('prixActuel').textContent = prixActuel.toFixed(decimales);
        document.getElementById('prixDeviseActuelle').textContent = deviseText;
        document.getElementById('prixDeviseLabel').textContent = `(${deviseText})`;
        document.getElementById('prixDeviseSymbole').textContent = symbole;
        document.getElementById('nouveau_prix').value = prixActuel;
        document.getElementById('nouveau_prix').step = isUSD ? '0.01' : '1';
        document.getElementById('commentaire_prix').value = '';
        document.getElementById('changementPrixInfo').style.display = 'none';
    };
    
    // Afficher le changement de prix en temps réel
    document.getElementById('nouveau_prix').addEventListener('input', function() {
        const nouveauPrix = parseFloat(this.value) || 0;
        const difference = nouveauPrix - currentPrixActuel;
        const pourcentage = currentPrixActuel > 0 ? ((difference / currentPrixActuel) * 100).toFixed(1) : 0;
        
        const isUSD = currentPrixDevise === 'USD';
        const symbole = isUSD ? '$' : 'CDF';
        const decimales = isUSD ? 2 : 0;
        
        if (Math.abs(difference) > 0.01) {
            const changementDiv = document.getElementById('changementPrixInfo');
            const changementText = document.getElementById('changementPrixText');
            
            if (difference > 0) {
                changementDiv.className = 'alert alert-success';
                changementText.innerHTML = `+${difference.toFixed(decimales)} ${symbole} (+${pourcentage}%)`;
            } else {
                changementDiv.className = 'alert alert-danger';
                changementText.innerHTML = `${difference.toFixed(decimales)} ${symbole} (${pourcentage}%)`;
            }
            
            changementDiv.style.display = 'block';
        } else {
            document.getElementById('changementPrixInfo').style.display = 'none';
        }
    });
    
    // Validation par touche Enter pour le formulaire de prix
    document.getElementById('formModifierPrix').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('btnModifierPrix').click();
        }
    });
    
    // Soumission modification prix
    document.getElementById('btnModifierPrix').addEventListener('click', function() {
        const form = document.getElementById('formModifierPrix');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
        
        const formData = new FormData(form);
        
        fetch(`/commercant/boutiques/{{ boutique.id }}/articles/${currentPrixArticleId}/modifier-prix/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fermer le modal et recharger
                bootstrap.Modal.getInstance(document.getElementById('modifierPrixModal')).hide();
                location.reload();
            } else {
                alert('Erreur: ' + (data.message || 'Une erreur est survenue'));
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Enregistrer le Prix';
            }
        })
        .catch(error => {
            alert('Erreur réseau: ' + error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Enregistrer le Prix';
        });
    });
});
</script>
{% endblock %}
