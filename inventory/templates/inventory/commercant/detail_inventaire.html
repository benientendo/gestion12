{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}{{ inventaire.reference }} - {{ depot.nom }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-clipboard-list text-primary"></i> {{ inventaire.reference }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'inventory:detail_depot' depot.id %}">{{ depot.nom }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'inventory:liste_inventaires' depot.id %}">Inventaires</a></li>
                    <li class="breadcrumb-item active">{{ inventaire.reference }}</li>
                </ol>
            </nav>
        </div>
        <div>
            {% if inventaire.statut == 'EN_COURS' %}
            <a href="{% url 'inventory:saisir_inventaire' depot.id inventaire.id %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Continuer la saisie
            </a>
            {% elif inventaire.statut == 'TERMINE' %}
            <a href="{% url 'inventory:regulariser_inventaire' depot.id inventaire.id %}" class="btn btn-success">
                <i class="fas fa-sync"></i> Régulariser le stock
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Statut et infos -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    {% if inventaire.statut == 'EN_COURS' %}
                    <span class="badge bg-warning text-dark fs-6"><i class="fas fa-clock"></i> En cours</span>
                    {% elif inventaire.statut == 'TERMINE' %}
                    <span class="badge bg-info fs-6"><i class="fas fa-check"></i> Terminé</span>
                    {% elif inventaire.statut == 'REGULARISE' %}
                    <span class="badge bg-success fs-6"><i class="fas fa-check-double"></i> Régularisé</span>
                    {% endif %}
                    <p class="mb-0 mt-2 text-muted">{{ inventaire.date_inventaire|date:"d/m/Y" }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ inventaire.nb_articles }}</h3>
                    <small class="text-muted">Articles</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ lignes_saisies }}</h3>
                    <small class="text-muted">Saisis</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card {% if lignes_avec_ecart > 0 %}border-danger{% endif %}">
                <div class="card-body text-center">
                    <h3 class="mb-0 {% if lignes_avec_ecart > 0 %}text-danger{% endif %}">{{ lignes_avec_ecart }}</h3>
                    <small class="text-muted">Écarts</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Résumé des écarts -->
    {% if lignes_avec_ecart > 0 %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="text-success"><i class="fas fa-arrow-up"></i> Écarts positifs (surplus)</h6>
                    <h4 class="text-success mb-0">+{{ total_ecart_positif|floatformat:0 }} FC</h4>
                    <small class="text-muted">{{ ecarts_positifs.count }} article(s)</small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="text-danger"><i class="fas fa-arrow-down"></i> Écarts négatifs (manques)</h6>
                    <h4 class="text-danger mb-0">-{{ total_ecart_negatif|floatformat:0 }} FC</h4>
                    <small class="text-muted">{{ ecarts_negatifs.count }} article(s)</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Liste des articles avec écarts -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-list"></i> Détail des articles</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Article</th>
                            <th class="text-center">Stock système</th>
                            <th class="text-center">Stock physique</th>
                            <th class="text-center">Écart</th>
                            <th class="text-end">Valeur écart</th>
                            <th>Commentaire</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ligne in lignes %}
                        <tr class="{% if ligne.ecart > 0 %}table-success{% elif ligne.ecart < 0 %}table-danger{% endif %}">
                            <td>
                                <strong>{{ ligne.article.nom }}</strong>
                                {% if ligne.article.categorie %}
                                <br><small class="text-muted">{{ ligne.article.categorie.nom }}</small>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ ligne.stock_theorique }}</td>
                            <td class="text-center">
                                {% if ligne.stock_physique is not None %}
                                {{ ligne.stock_physique }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if ligne.ecart > 0 %}
                                <span class="badge bg-success">+{{ ligne.ecart }}</span>
                                {% elif ligne.ecart < 0 %}
                                <span class="badge bg-danger">{{ ligne.ecart }}</span>
                                {% elif ligne.stock_physique is not None %}
                                <span class="badge bg-secondary">0</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if ligne.valeur_ecart > 0 %}
                                <span class="text-success">+{{ ligne.valeur_ecart|floatformat:0 }} FC</span>
                                {% elif ligne.valeur_ecart < 0 %}
                                <span class="text-danger">{{ ligne.valeur_ecart|floatformat:0 }} FC</span>
                                {% endif %}
                            </td>
                            <td><small>{{ ligne.commentaire }}</small></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">Aucun article</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Actions -->
    {% if inventaire.statut == 'EN_COURS' %}
    <div class="card mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Terminer l'inventaire</strong>
                    <p class="mb-0 text-muted">Une fois terminé, vous pourrez régulariser le stock.</p>
                </div>
                <form method="post" action="{% url 'inventory:terminer_inventaire' depot.id inventaire.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-info" onclick="return confirm('Terminer la saisie de cet inventaire ?')">
                        <i class="fas fa-check"></i> Terminer l'inventaire
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
