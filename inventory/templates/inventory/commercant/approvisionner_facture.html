{% extends 'inventory/base.html' %}
{% load static l10n %}

{% block title %}Facture Fournisseur - {{ depot.nom }}{% endblock %}

{% block extra_css %}
<style>
    /* === PAGE FIXE === */
    .page-facture { height: calc(100vh - 56px); display: flex; flex-direction: column; overflow: hidden; padding: 6px 16px; }
    .facture-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 6px 16px; border-radius: 8px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
    .facture-header h5 { margin: 0; font-size: 1.1rem; }
    .facture-header .btn { padding: 5px 14px; font-size: .88rem; }
    .facture-body { flex: 1; display: flex; gap: 12px; min-height: 0; overflow: hidden; }
    .facture-left { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
    .facture-right { width: 250px; flex-shrink: 0; display: flex; flex-direction: column; }

    /* === SECTIONS === */
    .sec { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,.07); margin-bottom: 5px; }
    .sec-h { background: #f8f9fa; padding: 4px 14px; border-bottom: 1px solid #e9ecef; font-weight: 600; font-size: .9rem; display: flex; align-items: center; justify-content: space-between; }
    .sec-b { padding: 6px 14px; }

    /* === FORMULAIRE === */
    .form-label { font-size: .85rem; margin-bottom: 3px; font-weight: 600; color: #444; }
    .form-control-sm, .form-select-sm { font-size: .9rem; padding: 5px 10px; height: 36px; }
    .mb-1x { margin-bottom: 4px !important; }
    .row.gx-2 { --bs-gutter-x: 8px; }

    /* === ZONE SAISIE ARTICLE (fixe) === */
    .saisie-article { background: #eef2ff; border: 2px solid #667eea; border-radius: 8px; padding: 6px 12px; }
    .saisie-article .form-label { color: #333; }
    .carton-fields { background: #fff8e1; border-radius: 6px; padding: 5px 10px; margin-top: 3px; }
    .saisie-apercu { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
    .saisie-apercu .badge-total { background: #d4edda; color: #155724; padding: 5px 14px; border-radius: 5px; font-weight: 600; font-size: .88rem; }
    .saisie-apercu .badge-total-blue { background: #cce5ff; color: #004085; }
    .btn-ajouter-article { padding: 7px 20px; font-size: .9rem; font-weight: 600; }
    .input-matched { background: #e8f5e9 !important; border-color: #4caf50 !important; }

    /* === TABLEAU ARTICLES AJOUTÉS === */
    .table-articles-zone { flex: 1; overflow-y: auto; min-height: 0; }
    .table-articles { width: 100%; font-size: .88rem; border-collapse: collapse; }
    .table-articles thead th { background: #f8f9fa; padding: 7px 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #555; position: sticky; top: 0; font-size: .82rem; }
    .table-articles tbody td { padding: 6px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .table-articles tbody tr:hover { background: #f0f2ff; }
    .table-articles .text-end { text-align: right; }
    .table-articles .btn-sm { padding: 3px 8px; font-size: .78rem; }
    .table-articles-zone:empty::before { content: "Aucun article ajouté. Saisissez un article ci-dessus puis cliquez Ajouter ou appuyez sur Entrée."; display: block; text-align: center; padding: 24px; color: #999; font-style: italic; font-size: .88rem; }

    /* === RÉSUMÉ === */
    .resume-row { display: flex; justify-content: space-between; font-size: .9rem; padding: 4px 0; }
    .total-box { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: #fff; padding: 12px 14px; border-radius: 8px; text-align: right; }
    .total-box h4 { margin: 0; font-size: 1.4rem; }
    .total-box small { font-size: .78rem; }
    .btn-save { font-size: .95rem; padding: 8px 14px; }

    /* === FOCUS === */
    .form-control-sm:focus, .form-select-sm:focus { box-shadow: 0 0 0 2px rgba(102,126,234,.35); border-color: #667eea; }

    /* === CONVERSION === */
    .conv-info { font-size: .78rem; color: #17a2b8; }

    /* === HINTS ANCIEN PRIX === */
    .hint-prev { display: none; font-size: .74rem; color: #6c757d; margin-top: 2px; line-height: 1.2; cursor: pointer; }
    .hint-prev .hint-val { background: #e3f2fd; color: #1565c0; padding: 1px 5px; border-radius: 3px; font-weight: 600; }
    .hint-prev:hover .hint-val { background: #bbdefb; }
    .hint-prev.visible { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="page-facture">
    <div class="facture-header">
        <h5><i class="fas fa-file-invoice me-1"></i>Facture Fournisseur &mdash; {{ depot.nom }}</h5>
        <a href="{% url 'inventory:detail_depot' depot.id %}" class="btn btn-light btn-sm"><i class="fas fa-arrow-left"></i> Retour</a>
    </div>

    <form method="post" id="factureForm" onsubmit="return validerFormulaire()" class="facture-body">
        {% csrf_token %}
        <input type="hidden" name="articles_json" id="articles_json" value="[]">

        <div class="facture-left">
            <!-- Infos facture -->
            <div class="sec">
                <div class="sec-h"><span><i class="fas fa-info-circle me-1"></i>Informations de la facture</span></div>
                <div class="sec-b">
                    <div class="row gx-2 align-items-end">
                        <div class="col-4 mb-1x">
                            <label class="form-label">Fournisseur <small class="text-muted fw-normal">(tapez pour rechercher ou créer)</small></label>
                            <input type="text" class="form-control form-control-sm nav-field" id="fournisseur_input" list="datalistFournisseurs" placeholder="Nom du fournisseur" autocomplete="off" oninput="onFournisseurInput()" autofocus>
                            <input type="hidden" name="fournisseur_id" id="fournisseur_id" value="">
                            <input type="hidden" name="fournisseur_nom" id="fournisseur_nom" value="">
                        </div>
                        <div class="col-3 mb-1x">
                            <label class="form-label">Numéro de facture *</label>
                            <input type="text" class="form-control form-control-sm nav-field" name="numero_facture" id="numero_facture" required placeholder="Ex: FACT-001">
                        </div>
                        <div class="col-2 mb-1x">
                            <label class="form-label">Date facture *</label>
                            <input type="date" class="form-control form-control-sm nav-field" name="date_facture" id="date_facture" value="{{ today }}" required>
                        </div>
                        <div class="col-3 mb-1x">
                            <label class="form-label">Devise</label>
                            <div class="d-flex gap-3 mt-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="devise" id="devise_cdf" value="CDF" checked onchange="onDeviseChange()">
                                    <label class="form-check-label fw-semibold" for="devise_cdf" style="font-size:.85rem;">FC <small class="text-muted">Franc</small></label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="devise" id="devise_usd" value="USD" onchange="onDeviseChange()">
                                    <label class="form-check-label fw-semibold" for="devise_usd" style="font-size:.85rem;">$ <small class="text-muted">Dollar</small></label>
                                </div>
                            </div>
                            <input type="hidden" id="taux_dollar" value="{{ depot.taux_dollar }}">
                        </div>
                    </div>
                    <div class="row gx-2 align-items-end">
                        <div class="col mb-1x">
                            <input type="text" class="form-control form-control-sm nav-field" name="notes" placeholder="Notes (optionnel)" style="height:36px;">
                        </div>
                        <div class="col-auto mb-1x" id="info_conversion" style="display:none;">
                            <span class="conv-info"><i class="fas fa-exchange-alt"></i> 1$ = <span id="taux_affiche">{{ depot.taux_dollar|floatformat:0 }}</span> FC</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone saisie article (FIXE) -->
            <div class="sec">
                <div class="sec-h">
                    <span><i class="fas fa-edit me-1"></i>Saisir un article</span>
                    <span class="text-muted" style="font-weight:normal;font-size:.68rem;">Remplissez puis Enter ou cliquez Ajouter</span>
                </div>
                <div class="sec-b saisie-article">
                    <div class="row gx-2 align-items-end">
                        <div class="col-3 mb-1x">
                            <label class="form-label">Nom de l'article *</label>
                            <input type="text" class="form-control form-control-sm art-field" id="art_nom" list="datalistArticles" placeholder="Tapez pour chercher ou créer" autocomplete="off" oninput="onSaisieArticleInput()">
                            <input type="hidden" id="art_id" value="">
                            <input type="hidden" id="art_code" value="">
                        </div>
                        <div class="col-2 mb-1x">
                            <label class="form-label">Catégorie</label>
                            <input type="text" class="form-control form-control-sm art-field" id="art_categorie" list="datalistCategories" placeholder="Tapez pour rechercher ou créer" autocomplete="off" oninput="onSaisieCategorieInput()">
                            <input type="hidden" id="art_categorie_id" value="">
                            <input type="hidden" id="art_categorie_nom" value="">
                        </div>
                        <div class="col-2 mb-1x">
                            <label class="form-label">Type de quantité</label>
                            <select class="form-select form-select-sm art-field" id="art_type" onchange="onSaisieTypeChange()">
                                <option value="UNITE">Unités</option>
                                <option value="CARTON" selected>Cartons</option>
                            </select>
                        </div>
                        <!-- Champs UNITÉS -->
                        <div class="col-1 mb-1x champs-saisie-unite">
                            <label class="form-label">Quantité *</label>
                            <input type="number" class="form-control form-control-sm art-field" id="art_qte" min="1" value="1" oninput="calculerSaisie()">
                            <div class="hint-prev" id="hint_qte" onclick="applyHint('art_qte',this)">stock: <span class="hint-val"></span></div>
                        </div>
                        <div class="col-2 mb-1x champs-saisie-unite">
                            <label class="form-label">Prix de vente</label>
                            <input type="number" class="form-control form-control-sm art-field" id="art_prix_vente" min="0" step="0.01" value="0" oninput="calculerSaisie()">
                            <div class="hint-prev" id="hint_prix_vente" onclick="applyHint('art_prix_vente',this)">avant: <span class="hint-val"></span></div>
                        </div>
                        <div class="col-auto mb-1x champs-saisie-unite" id="prixVenteFC" style="display:none;">
                            <label class="form-label" style="color:#198754;font-weight:700;">P.V. en FC</label>
                            <div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:6px;padding:5px 14px;font-size:1.1rem;font-weight:800;color:#198754;min-width:120px;text-align:center;" id="prixVenteFCVal">0 FC</div>
                        </div>
                    </div>
                    <!-- Champs CARTONS (cachés par défaut) -->
                    <div class="carton-fields" id="cartonFields" style="display:none;">
                        <div class="row gx-2 align-items-end">
                            <div class="col mb-1x"><label class="form-label">Nb. cartons</label><input type="number" class="form-control form-control-sm art-field" id="art_nb_cartons" min="0" value="1" oninput="calculerSaisie()"><div class="hint-prev" id="hint_nb_cartons" onclick="applyHint('art_nb_cartons',this)">avant: <span class="hint-val"></span></div></div>
                            <div class="col mb-1x"><label class="form-label">Pièces/carton</label><input type="number" class="form-control form-control-sm art-field" id="art_pcs_carton" min="1" value="1" oninput="calculerSaisie()"><div class="hint-prev" id="hint_pcs_carton" onclick="applyHint('art_pcs_carton',this)">avant: <span class="hint-val"></span></div></div>
                            <div class="col mb-1x"><label class="form-label">Pièces en +</label><input type="number" class="form-control form-control-sm art-field" id="art_pcs_sup" min="0" value="0" oninput="calculerSaisie()"></div>
                            <div class="col mb-1x"><label class="form-label">Prix/carton</label><input type="number" class="form-control form-control-sm art-field" id="art_prix_carton" min="0" step="0.01" value="0" oninput="calculerSaisie()"><div class="hint-prev" id="hint_prix_carton" onclick="applyHint('art_prix_carton',this)">avant: <span class="hint-val"></span></div></div>
                            <div class="col mb-1x"><label class="form-label">Prix/pièce sup.</label><input type="number" class="form-control form-control-sm art-field" id="art_prix_pcs_sup" min="0" step="0.01" value="0" oninput="calculerSaisie()"></div>
                            <div class="col mb-1x"><label class="form-label">Prix de vente</label><input type="number" class="form-control form-control-sm art-field" id="art_prix_vente_carton" min="0" step="0.01" value="0" oninput="calculerSaisie()"><div class="hint-prev" id="hint_prix_vente_carton" onclick="applyHint('art_prix_vente_carton',this)">avant: <span class="hint-val"></span></div></div>
                            <div class="col-auto mb-1x" id="prixVenteCartonFC" style="display:none;"><label class="form-label" style="color:#198754;font-weight:700;">P.V. en FC</label><div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:6px;padding:5px 10px;font-size:1rem;font-weight:800;color:#198754;min-width:100px;text-align:center;" id="prixVenteCartonFCVal">0 FC</div></div>
                        </div>
                    </div>
                    <!-- Prix d'achat toujours visible -->
                    <div class="row gx-2 align-items-end">
                        <div class="col-3 mb-1x">
                            <label class="form-label">Prix d'achat unitaire *</label>
                            <input type="number" class="form-control form-control-sm art-field" id="art_prix_achat" min="0" step="0.01" value="0" oninput="calculerSaisie()">
                            <div class="hint-prev" id="hint_prix_achat" onclick="applyHint('art_prix_achat',this)">avant: <span class="hint-val"></span></div>
                        </div>
                        <div class="col-auto mb-1x" id="prixAchatFC" style="display:none;">
                            <label class="form-label" style="color:#e65100;font-weight:700;">Équiv. FC</label>
                            <div style="background:#fff3e0;border:2px solid #ff9800;border-radius:6px;padding:5px 14px;font-size:1.1rem;font-weight:800;color:#e65100;min-width:120px;text-align:center;" id="prixAchatFCVal">0 FC</div>
                        </div>
                    </div>
                    <!-- Aperçu + bouton ajouter -->
                    <div class="saisie-apercu">
                        <div>
                            <span class="badge-total badge-total-blue" id="saisieTotal">Sous-total: 0</span>
                            <span class="conv-info" id="saisieConversion" style="display:none;margin-left:6px;">(<span id="saisieTotalConv">0</span> FC)</span>
                        </div>
                        <button type="button" class="btn btn-success btn-ajouter-article" onclick="ajouterArticle()" title="Ajouter cet article à la facture">
                            <i class="fas fa-plus me-1"></i>Ajouter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tableau articles ajoutés -->
            <div class="sec" style="flex:1;display:flex;flex-direction:column;min-height:0;">
                <div class="sec-h">
                    <span><i class="fas fa-list me-1"></i>Articles ajoutés (<span id="nbArticlesHeader">0</span>)</span>
                    <span id="saveIndicator" style="font-size:.7rem;color:#198754;display:none;"><i class="fas fa-check-circle me-1"></i>Brouillon sauvegardé</span>
                </div>
                <div class="table-articles-zone" id="tableArticlesZone">
                </div>
            </div>
        </div>

        <!-- Résumé à droite -->
        <div class="facture-right">
            <div class="sec" style="flex:1;display:flex;flex-direction:column;">
                <div class="sec-h"><i class="fas fa-calculator me-1"></i>Résumé</div>
                <div class="sec-b" style="flex:1;display:flex;flex-direction:column;justify-content:space-between;">
                    <div>
                        <div class="resume-row"><span>Nombre d'articles:</span><strong id="nbArticles">0</strong></div>
                        <div class="resume-row"><span>Total unités:</span><strong id="totalUnites">0</strong></div>
                        <hr style="margin:5px 0;">
                        <div class="total-box">
                            <small>Montant total</small>
                            <h4 id="montantTotal">0 <span id="deviseTotal" style="font-size:.75rem;">CDF</span></h4>
                        </div>
                    </div>
                    <div class="d-grid gap-1 mt-2">
                        <button type="submit" class="btn btn-primary btn-save" id="btnEnregistrer" disabled>
                            <i class="fas fa-save me-1"></i>Enregistrer (Ctrl+S)
                        </button>
                        <a href="{% url 'inventory:liste_factures_depot' depot.id %}" class="btn btn-outline-info btn-sm" style="font-size:.72rem;"><i class="fas fa-file-invoice me-1"></i>Mes factures</a>
                        <a href="{% url 'inventory:detail_depot' depot.id %}" class="btn btn-outline-secondary btn-sm" style="font-size:.72rem;">Annuler</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Datalists -->
<datalist id="datalistFournisseurs">
    {% for f in fournisseurs %}
    <option value="{{ f.nom }}" data-id="{{ f.id }}"></option>
    {% endfor %}
</datalist>
<datalist id="datalistArticles">
    {% for art in articles_existants %}
    <option value="{{ art.nom }}"></option>
    {% endfor %}
</datalist>
<datalist id="datalistCategories">
    {% for cat in categories %}
    <option value="{{ cat.nom }}"></option>
    {% endfor %}
</datalist>
{% endblock %}

{% block extra_js %}
<script>
// === DONNÉES DJANGO ===
{% localize off %}
var FACT_FOURNISSEURS = [
    {% for f in fournisseurs %}
    { id: {{ f.id }}, nom: "{{ f.nom|escapejs }}" },
    {% endfor %}
];
var FACT_CATEGORIES = [
    {% for cat in categories %}
    { id: {{ cat.id }}, nom: "{{ cat.nom|escapejs }}" },
    {% endfor %}
];
var FACT_ARTICLES = [
    {% for art in articles_existants %}
    { id: {{ art.id }}, nom: "{{ art.nom|escapejs }}", code: "{{ art.code|escapejs }}", prix_vente: {{ art.prix_vente|default:"0" }}, prix_achat: {{ art.prix_achat|default:"0" }}, devise: "{{ art.devise|default:'CDF' }}", stock: {{ art.quantite_stock|default:"0" }}, categorie_id: "{{ art.categorie_id|default:'' }}" },
    {% endfor %}
];
{% endlocalize %}

// Dernières données d'approvisionnement par article (carton, prix, etc.)
var FACT_DERNIERS_APPROS = {{ derniers_appros_json|safe }};

// === HELPERS DEVISE (radio buttons) ===
function getDevise() {
    var r = document.querySelector('input[name="devise"]:checked');
    return r ? r.value : 'CDF';
}
function setDevise(val) {
    var el = document.getElementById('devise_' + val.toLowerCase());
    if (el) el.checked = true;
}
function onDeviseChange() {
    getEl('info_conversion').style.display = getDevise() === 'USD' ? 'block' : 'none';
    calculerSaisie();
    factRafraichirTableau();
    factMajResume();
    factSaveState();
}

// === ÉTAT ===
var factArticlesAjoutes = [];
var FACT_STORAGE_KEY = 'facture_brouillon_{{ depot.id }}';

// === PERSISTANCE localStorage ===
function factSaveState() {
    try {
        var state = {
            articles: factArticlesAjoutes,
            header: {
                numero_facture: getEl('numero_facture').value,
                date_facture: getEl('date_facture').value,
                devise: getDevise(),
                fournisseur_input: getEl('fournisseur_input').value,
                fournisseur_id: getEl('fournisseur_id').value,
                fournisseur_nom: getEl('fournisseur_nom').value,
                notes: document.querySelector('input[name="notes"]').value
            },
            savedAt: new Date().toISOString()
        };
        localStorage.setItem(FACT_STORAGE_KEY, JSON.stringify(state));
        // Indicateur visuel
        var ind = getEl('saveIndicator');
        if (ind) {
            ind.style.display = 'inline';
            ind.textContent = '\u2713 Brouillon sauvegardé (' + factArticlesAjoutes.length + ' art.)';
            clearTimeout(window._saveTimer);
            window._saveTimer = setTimeout(function() { ind.style.display = 'none'; }, 3000);
        }
        console.log('\ud83d\udcbe Sauvegardé:', factArticlesAjoutes.length, 'articles');
    } catch(err) { console.warn('Save state error:', err); }
}

// Sauvegarder automatiquement avant de quitter la page
window.addEventListener('beforeunload', function() {
    if (factArticlesAjoutes.length > 0) factSaveState();
});

function factLoadState() {
    try {
        var raw = localStorage.getItem(FACT_STORAGE_KEY);
        if (!raw) return false;
        var state = JSON.parse(raw);
        if (!state || !state.articles || state.articles.length === 0) {
            // Restaurer seulement l'en-tête s'il y a des données
            if (state && state.header) {
                var h = state.header;
                if (h.numero_facture) getEl('numero_facture').value = h.numero_facture;
                if (h.date_facture) getEl('date_facture').value = h.date_facture;
                if (h.devise) setDevise(h.devise);
                if (h.fournisseur_input) {
                    getEl('fournisseur_input').value = h.fournisseur_input;
                    if (h.fournisseur_id) {
                        getEl('fournisseur_id').value = h.fournisseur_id;
                        getEl('fournisseur_input').classList.add('input-matched');
                    }
                    if (h.fournisseur_nom) getEl('fournisseur_nom').value = h.fournisseur_nom;
                }
                if (h.notes) document.querySelector('input[name="notes"]').value = h.notes;
            }
            return false;
        }
        // Restaurer les articles
        factArticlesAjoutes = state.articles;
        // Restaurer l'en-tête
        if (state.header) {
            var h = state.header;
            if (h.numero_facture) getEl('numero_facture').value = h.numero_facture;
            if (h.date_facture) getEl('date_facture').value = h.date_facture;
            if (h.devise) {
                setDevise(h.devise);
                getEl('info_conversion').style.display = h.devise === 'USD' ? 'block' : 'none';
            }
            if (h.fournisseur_input) {
                getEl('fournisseur_input').value = h.fournisseur_input;
                if (h.fournisseur_id) {
                    getEl('fournisseur_id').value = h.fournisseur_id;
                    getEl('fournisseur_input').classList.add('input-matched');
                }
                if (h.fournisseur_nom) getEl('fournisseur_nom').value = h.fournisseur_nom;
            }
            if (h.notes) document.querySelector('input[name="notes"]').value = h.notes;
        }
        factRafraichirTableau();
        factMajResume();
        var savedAt = state.savedAt ? new Date(state.savedAt) : null;
        var timeStr = savedAt ? savedAt.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) : '';
        console.log('\ud83d\udccb Brouillon restaur\u00e9: ' + factArticlesAjoutes.length + ' articles' + (timeStr ? ' (sauvegard\u00e9 \u00e0 ' + timeStr + ')' : ''));
        // Indicateur visuel de restauration
        var ind = getEl('saveIndicator');
        if (ind) {
            ind.style.display = 'inline';
            ind.style.color = '#0d6efd';
            ind.textContent = '\ud83d\udccb Restaur\u00e9: ' + factArticlesAjoutes.length + ' articles' + (timeStr ? ' (sauvegard\u00e9 \u00e0 ' + timeStr + ')' : '');
            setTimeout(function() { ind.style.display = 'none'; ind.style.color = '#198754'; }, 5000);
        }
        return true;
    } catch(err) { console.warn('Load state error:', err); return false; }
}

function factClearState() {
    try { localStorage.removeItem(FACT_STORAGE_KEY); } catch(err) {}
}

// === HELPER ===
function getEl(id) { return document.getElementById(id); }
function factFormatNumber(n) { return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 2 }).format(n); }
function factGetTaux() { return parseFloat(getEl('taux_dollar').value) || 2800; }
function factEscapeHtml(str) { var d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

// === ARTICLE SÉLECTIONNÉ (pour hints) ===
var factSelectedArticle = null;

function showHint(hintId, value, devise) {
    var el = getEl(hintId);
    if (!el) return;
    var span = el.querySelector('.hint-val');
    if (span) span.textContent = factFormatNumber(value) + (devise ? ' ' + devise : '');
    el.classList.add('visible');
    el.dataset.hintValue = value;
}

function hideAllHints() {
    var hints = document.querySelectorAll('.hint-prev');
    for (var i = 0; i < hints.length; i++) {
        hints[i].classList.remove('visible');
        hints[i].dataset.hintValue = '';
    }
    factSelectedArticle = null;
}

function applyHint(fieldId, hintEl) {
    var val = hintEl.dataset.hintValue;
    if (val !== undefined && val !== '') {
        getEl(fieldId).value = val;
        calculerSaisie();
    }
}

// =============================================
// NAVIGATION ENTER
// =============================================
function factGetVisibleFields() {
    var type = getEl('art_type').value;
    var all = document.querySelectorAll('.nav-field, .art-field');
    var result = [];
    for (var i = 0; i < all.length; i++) {
        var f = all[i];
        if (f.offsetParent === null) continue;
        if (type === 'CARTON' && f.closest('.champs-saisie-unite')) continue;
        if (type !== 'CARTON' && f.closest('.carton-fields')) continue;
        result.push(f);
    }
    return result;
}

document.addEventListener('keydown', function(e) {
    try {
        if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
            e.preventDefault();
            soumettreFactureAjax();
            return;
        }
        if (e.key !== 'Enter') return;
        var el = document.activeElement;
        if (!el) return;
        if (el.tagName === 'BUTTON' || el.type === 'submit') return;
        e.preventDefault();

        var fields = factGetVisibleFields();
        var idx = -1;
        for (var i = 0; i < fields.length; i++) {
            if (fields[i] === el) { idx = i; break; }
        }
        if (idx < 0) return;

        if (idx === fields.length - 1 && el.classList.contains('art-field')) {
            ajouterArticle();
            return;
        }
        if (idx < fields.length - 1) {
            fields[idx + 1].focus();
            if (fields[idx + 1].select) fields[idx + 1].select();
        }
    } catch(err) { console.error('Enter nav error:', err); }
});

// =============================================
// AUTOCOMPLETE ARTICLE
// =============================================
function onSaisieArticleInput() {
    try {
        var input = getEl('art_nom');
        var val = input.value.trim();
        var match = null;
        for (var i = 0; i < FACT_ARTICLES.length; i++) {
            if (FACT_ARTICLES[i].nom.toLowerCase() === val.toLowerCase()) { match = FACT_ARTICLES[i]; break; }
        }
        if (match) {
            factSelectedArticle = match;
            getEl('art_id').value = match.id;
            getEl('art_code').value = match.code;
            input.classList.add('input-matched');

            // Catégorie
            if (match.categorie_id) {
                for (var j = 0; j < FACT_CATEGORIES.length; j++) {
                    if (String(FACT_CATEGORIES[j].id) === String(match.categorie_id)) {
                        getEl('art_categorie').value = FACT_CATEGORIES[j].nom;
                        getEl('art_categorie_id').value = FACT_CATEGORIES[j].id;
                        getEl('art_categorie_nom').value = '';
                        getEl('art_categorie').classList.add('input-matched');
                        break;
                    }
                }
            }

            var dev = match.devise || 'CDF';
            var appro = FACT_DERNIERS_APPROS[String(match.id)];

            // Si dernière facture était en carton, basculer automatiquement
            if (appro && appro.type_quantite === 'CARTON') {
                getEl('art_type').value = 'CARTON';
                onSaisieTypeChange(true);
                // Pré-remplir champs carton
                if (appro.nombre_cartons > 0) {
                    getEl('art_nb_cartons').value = appro.nombre_cartons;
                    showHint('hint_nb_cartons', appro.nombre_cartons, 'crt');
                }
                if (appro.pieces_par_carton > 0) {
                    getEl('art_pcs_carton').value = appro.pieces_par_carton;
                    showHint('hint_pcs_carton', appro.pieces_par_carton, 'pcs');
                }
                if (appro.prix_achat_carton > 0) {
                    getEl('art_prix_carton').value = appro.prix_achat_carton;
                    showHint('hint_prix_carton', appro.prix_achat_carton, dev);
                }
            }

            // Pré-remplir prix d'achat + hint
            if (appro && appro.prix_achat_unitaire > 0) {
                getEl('art_prix_achat').value = appro.prix_achat_unitaire;
                showHint('hint_prix_achat', appro.prix_achat_unitaire, dev);
            } else if (match.prix_achat > 0) {
                getEl('art_prix_achat').value = match.prix_achat;
                showHint('hint_prix_achat', match.prix_achat, dev);
            }

            // Pré-remplir prix de vente + hint
            if (match.prix_vente > 0) {
                getEl('art_prix_vente').value = match.prix_vente;
                getEl('art_prix_vente_carton').value = match.prix_vente;
                showHint('hint_prix_vente', match.prix_vente, dev);
                showHint('hint_prix_vente_carton', match.prix_vente, dev);
            }

            // Hint stock actuel
            showHint('hint_qte', match.stock, '');

            calculerSaisie();
        } else {
            getEl('art_id').value = '';
            getEl('art_code').value = '';
            input.classList.remove('input-matched');
            hideAllHints();
        }
    } catch(err) { console.error('Article input error:', err); }
}

// =============================================
// AUTOCOMPLETE CATÉGORIE
// =============================================
function onSaisieCategorieInput() {
    try {
        var input = getEl('art_categorie');
        var val = input.value.trim();
        var match = null;
        for (var i = 0; i < FACT_CATEGORIES.length; i++) {
            if (FACT_CATEGORIES[i].nom.toLowerCase() === val.toLowerCase()) { match = FACT_CATEGORIES[i]; break; }
        }
        if (match) {
            getEl('art_categorie_id').value = match.id;
            getEl('art_categorie_nom').value = '';
            input.classList.add('input-matched');
        } else {
            getEl('art_categorie_id').value = '';
            getEl('art_categorie_nom').value = val;
            input.classList.remove('input-matched');
        }
    } catch(err) { console.error('Categorie input error:', err); }
}

// =============================================
// TYPE QUANTITÉ
// =============================================
function onSaisieTypeChange(skipFocus) {
    try {
        var type = getEl('art_type').value;
        var uniteFields = document.querySelectorAll('.champs-saisie-unite');
        var cartonDiv = getEl('cartonFields');
        if (type === 'CARTON') {
            for (var i = 0; i < uniteFields.length; i++) uniteFields[i].style.display = 'none';
            cartonDiv.style.display = 'block';
            if (!skipFocus) getEl('art_nb_cartons').focus();
        } else {
            for (var i = 0; i < uniteFields.length; i++) uniteFields[i].style.display = '';
            cartonDiv.style.display = 'none';
            if (!skipFocus) getEl('art_qte').focus();
        }
        calculerSaisie();
    } catch(err) { console.error('Type change error:', err); }
}

// =============================================
// CALCUL APERÇU
// =============================================
function calculerSaisie() {
    try {
        var type = getEl('art_type').value;
        var devise = getDevise();
        var total = 0, qteUnites = 0;
        if (type === 'CARTON') {
            var nc = parseFloat(getEl('art_nb_cartons').value) || 0;
            var ppc = parseFloat(getEl('art_pcs_carton').value) || 1;
            var ps = parseFloat(getEl('art_pcs_sup').value) || 0;
            var pc = parseFloat(getEl('art_prix_carton').value) || 0;
            var pps = parseFloat(getEl('art_prix_pcs_sup').value) || 0;
            var pu = ppc > 0 ? pc / ppc : 0;
            if (pps === 0 && ps > 0) pps = pu;
            qteUnites = (nc * ppc) + ps;
            total = (nc * pc) + (ps * pps);
            // Synchroniser le prix d'achat unitaire calculé
            getEl('art_prix_achat').value = Math.round(pu * 100) / 100;
        } else {
            qteUnites = parseFloat(getEl('art_qte').value) || 0;
            var pa = parseFloat(getEl('art_prix_achat').value) || 0;
            total = qteUnites * pa;
        }
        getEl('saisieTotal').textContent = 'Sous-total: ' + factFormatNumber(total) + (type === 'CARTON' ? ' (' + qteUnites + ' unités)' : '');
        // Afficher l'équivalent FC du prix d'achat unitaire
        var taux = factGetTaux();
        var pa_unit = parseFloat(getEl('art_prix_achat').value) || 0;
        if (devise === 'USD' && pa_unit > 0) {
            var paFC = pa_unit * taux;
            getEl('prixAchatFCVal').textContent = factFormatNumber(paFC) + ' FC';
            getEl('prixAchatFC').style.display = '';
        } else {
            getEl('prixAchatFC').style.display = 'none';
        }
        // Afficher l'équivalent FC du prix de vente
        if (devise === 'USD') {
            if (type === 'CARTON') {
                var pvCarton = parseFloat(getEl('art_prix_vente_carton').value) || 0;
                if (pvCarton > 0) {
                    getEl('prixVenteCartonFCVal').textContent = factFormatNumber(pvCarton * taux) + ' FC';
                    getEl('prixVenteCartonFC').style.display = '';
                } else {
                    getEl('prixVenteCartonFC').style.display = 'none';
                }
                getEl('prixVenteFC').style.display = 'none';
            } else {
                var pvUnit = parseFloat(getEl('art_prix_vente').value) || 0;
                if (pvUnit > 0) {
                    getEl('prixVenteFCVal').textContent = factFormatNumber(pvUnit * taux) + ' FC';
                    getEl('prixVenteFC').style.display = '';
                } else {
                    getEl('prixVenteFC').style.display = 'none';
                }
                getEl('prixVenteCartonFC').style.display = 'none';
            }
        } else {
            getEl('prixVenteFC').style.display = 'none';
            getEl('prixVenteCartonFC').style.display = 'none';
        }
        if (devise === 'USD' && total > 0) {
            getEl('saisieTotalConv').textContent = factFormatNumber(total * factGetTaux());
            getEl('saisieConversion').style.display = 'inline';
        } else {
            getEl('saisieConversion').style.display = 'none';
        }
    } catch(err) { console.error('Calcul error:', err); }
}

// =============================================
// AJOUTER ARTICLE
// =============================================
function ajouterArticle() {
    try {
        var nom = getEl('art_nom').value.trim();
        if (!nom) { alert('Saisissez le nom de l\'article'); getEl('art_nom').focus(); return; }

        var type = getEl('art_type').value;
        var art = {
            article_id: getEl('art_id').value || null,
            code: getEl('art_code').value || '',
            nom: nom,
            description: '',
            categorie_id: getEl('art_categorie_id').value || (factSelectedArticle ? factSelectedArticle.categorie_id : null) || null,
            categorie_nom: getEl('art_categorie_nom').value || '',
            type_quantite: type
        };

        if (type === 'CARTON') {
            art.nombre_cartons = parseInt(getEl('art_nb_cartons').value) || 0;
            art.pieces_par_carton = parseInt(getEl('art_pcs_carton').value) || 1;
            art.pieces_supplementaires = parseInt(getEl('art_pcs_sup').value) || 0;
            art.prix_achat_carton = parseFloat(getEl('art_prix_carton').value) || 0;
            art.prix_piece_sup = parseFloat(getEl('art_prix_pcs_sup').value) || 0;
            art.prix_vente = parseFloat(getEl('art_prix_vente_carton').value) || 0;
            art.prix_achat_unitaire = art.pieces_par_carton > 0 ? art.prix_achat_carton / art.pieces_par_carton : 0;
            if (art.prix_piece_sup === 0 && art.pieces_supplementaires > 0) art.prix_piece_sup = art.prix_achat_unitaire;
            art.quantite_unites = (art.nombre_cartons * art.pieces_par_carton) + art.pieces_supplementaires;
        } else {
            art.quantite_unites = parseInt(getEl('art_qte').value) || 0;
            art.prix_achat_unitaire = parseFloat(getEl('art_prix_achat').value) || 0;
            art.prix_vente = parseFloat(getEl('art_prix_vente').value) || 0;
            art.nombre_cartons = 0;
            art.pieces_par_carton = 1;
            art.prix_achat_carton = 0;
        }

        if (art.quantite_unites <= 0) { alert('La quantité doit être supérieure à 0'); return; }

        // Conversion USD → FC si devise Dollar
        if (getDevise() === 'USD') {
            var taux = factGetTaux();
            art.prix_achat_unitaire = Math.round(art.prix_achat_unitaire * taux * 100) / 100;
            art.prix_achat_carton = Math.round(art.prix_achat_carton * taux * 100) / 100;
            if (art.prix_piece_sup) art.prix_piece_sup = Math.round(art.prix_piece_sup * taux * 100) / 100;
            art.prix_vente = Math.round(art.prix_vente * taux * 100) / 100;
        }

        factArticlesAjoutes.unshift(art);
        factViderChamps();
        factRafraichirTableau();
        factMajResume();
        factSaveState();
        setTimeout(function() { getEl('art_nom').focus(); }, 50);
    } catch(err) { console.error('Ajouter article error:', err); alert('Erreur: ' + err.message); }
}

// =============================================
// VIDER LES CHAMPS
// =============================================
function factViderChamps() {
    getEl('art_nom').value = '';
    getEl('art_nom').classList.remove('input-matched');
    getEl('art_id').value = '';
    getEl('art_code').value = '';
    getEl('art_categorie').value = '';
    getEl('art_categorie').classList.remove('input-matched');
    getEl('art_categorie_id').value = '';
    getEl('art_categorie_nom').value = '';
    getEl('art_type').value = 'CARTON';
    getEl('art_qte').value = '1';
    getEl('art_prix_achat').value = '0';
    getEl('art_prix_vente').value = '0';
    getEl('art_nb_cartons').value = '1';
    getEl('art_pcs_carton').value = '1';
    getEl('art_pcs_sup').value = '0';
    getEl('art_prix_carton').value = '0';
    getEl('art_prix_pcs_sup').value = '0';
    getEl('art_prix_vente_carton').value = '0';
    var uf = document.querySelectorAll('.champs-saisie-unite');
    for (var i = 0; i < uf.length; i++) uf[i].style.display = 'none';
    getEl('cartonFields').style.display = 'block';
    getEl('saisieTotal').textContent = 'Sous-total: 0';
    getEl('saisieConversion').style.display = 'none';
    hideAllHints();
}

// =============================================
// TABLEAU
// =============================================
function factRafraichirTableau() {
    var zone = getEl('tableArticlesZone');
    if (factArticlesAjoutes.length === 0) { zone.innerHTML = ''; return; }
    var html = '<table class="table-articles"><thead><tr>';
    html += '<th>#</th><th>Article</th><th>Type</th><th class="text-end">Qté</th>';
    html += '<th class="text-end" style="color:#0d6efd;">P.A. Unit.</th>';
    html += '<th class="text-end" style="color:#0d6efd;">Total Achat</th>';
    html += '<th class="text-end" style="color:#198754;">P.V. Unit.</th>';
    html += '<th class="text-end" style="color:#198754;">Total Vente</th>';
    html += '<th></th>';
    html += '</tr></thead><tbody>';
    for (var i = 0; i < factArticlesAjoutes.length; i++) {
        var a = factArticlesAjoutes[i];
        var totalAchat = a.type_quantite === 'CARTON'
            ? (a.nombre_cartons * a.prix_achat_carton) + (a.pieces_supplementaires * (a.prix_piece_sup || a.prix_achat_unitaire))
            : a.quantite_unites * a.prix_achat_unitaire;
        var totalVente = a.quantite_unites * a.prix_vente;
        var typeLabel = a.type_quantite === 'CARTON' ? a.nombre_cartons + ' crt (' + a.quantite_unites + ' pcs)' : 'Unité';
        var prixAchat = a.prix_achat_unitaire;
        html += '<tr>';
        html += '<td>' + (i + 1) + '</td>';
        html += '<td><strong>' + factEscapeHtml(a.nom) + '</strong>' + (a.article_id ? ' <span class="badge bg-success" style="font-size:.55rem;">existant</span>' : ' <span class="badge bg-warning text-dark" style="font-size:.55rem;">nouveau</span>') + '</td>';
        html += '<td>' + typeLabel + '</td>';
        html += '<td class="text-end">' + a.quantite_unites + '</td>';
        html += '<td class="text-end" style="color:#0d6efd;">' + factFormatNumber(prixAchat) + '</td>';
        html += '<td class="text-end" style="color:#0d6efd;"><strong>' + factFormatNumber(totalAchat) + '</strong></td>';
        html += '<td class="text-end" style="color:#198754;">' + factFormatNumber(a.prix_vente) + '</td>';
        html += '<td class="text-end" style="color:#198754;"><strong>' + factFormatNumber(totalVente) + '</strong></td>';
        html += '<td><button type="button" class="btn btn-outline-danger btn-sm" onclick="supprimerArticle(' + i + ')" tabindex="-1"><i class="fas fa-trash"></i></button></td>';
        html += '</tr>';
    }
    html += '</tbody></table>';
    zone.innerHTML = html;
}

function supprimerArticle(index) {
    try {
        if (index < 0 || index >= factArticlesAjoutes.length) { console.warn('Index invalide:', index); return; }
        var nom = factArticlesAjoutes[index].nom || 'Article';
        if (!confirm('Supprimer "' + nom + '" de la liste ?')) return;
        factArticlesAjoutes.splice(index, 1);
        factRafraichirTableau();
        factMajResume();
        factSaveState();
    } catch(err) { console.error('Supprimer article error:', err); alert('Erreur suppression: ' + err.message); }
}

// =============================================
// RÉSUMÉ & JSON
// =============================================
function factMajResume() {
    var totalU = 0, montant = 0;
    for (var i = 0; i < factArticlesAjoutes.length; i++) {
        var a = factArticlesAjoutes[i];
        totalU += a.quantite_unites;
        if (a.type_quantite === 'CARTON') {
            montant += (a.nombre_cartons * a.prix_achat_carton) + (a.pieces_supplementaires * (a.prix_piece_sup || a.prix_achat_unitaire));
        } else {
            montant += a.quantite_unites * a.prix_achat_unitaire;
        }
    }
    getEl('nbArticles').textContent = factArticlesAjoutes.length;
    getEl('nbArticlesHeader').textContent = factArticlesAjoutes.length;
    getEl('totalUnites').textContent = totalU;
    getEl('montantTotal').textContent = factFormatNumber(montant);
    getEl('deviseTotal').textContent = 'FC';
    getEl('btnEnregistrer').disabled = (factArticlesAjoutes.length === 0);
    getEl('articles_json').value = JSON.stringify(factArticlesAjoutes);
}

// =============================================
// FOURNISSEUR
// =============================================
function onFournisseurInput() {
    try {
        var input = getEl('fournisseur_input');
        var val = input.value.trim();
        var match = null;
        for (var i = 0; i < FACT_FOURNISSEURS.length; i++) {
            if (FACT_FOURNISSEURS[i].nom.toLowerCase() === val.toLowerCase()) { match = FACT_FOURNISSEURS[i]; break; }
        }
        if (match) {
            getEl('fournisseur_id').value = match.id;
            getEl('fournisseur_nom').value = '';
            input.classList.add('input-matched');
        } else {
            getEl('fournisseur_id').value = '';
            getEl('fournisseur_nom').value = val;
            input.classList.remove('input-matched');
        }
    } catch(err) { console.error('Fournisseur error:', err); }
}

// =============================================
// VALIDATION FORMULAIRE
// =============================================
function validerFormulaire() {
    // Intercepter le submit normal et utiliser AJAX
    soumettreFactureAjax();
    return false;
}

function soumettreFactureAjax() {
    if (factArticlesAjoutes.length === 0) { alert('Veuillez ajouter au moins un article'); return; }
    if (!getEl('numero_facture').value.trim()) { alert('Le num\u00e9ro de facture est obligatoire'); getEl('numero_facture').focus(); return; }

    getEl('articles_json').value = JSON.stringify(factArticlesAjoutes);
    var btn = getEl('btnEnregistrer');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enregistrement en cours...';

    var form = getEl('factureForm');
    var formData = new FormData(form);

    fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(function(resp) { return resp.json().then(function(data) { return {ok: resp.ok, data: data}; }); })
    .then(function(result) {
        if (result.ok && result.data.success) {
            // Succès: vider les articles, garder l'en-tête
            factArticlesAjoutes = [];
            factRafraichirTableau();
            factMajResume();
            factClearState();
            // Message succès
            var ind = getEl('saveIndicator');
            if (ind) {
                ind.style.display = 'inline';
                ind.style.color = '#198754';
                ind.textContent = '\u2705 ' + result.data.message;
                clearTimeout(window._saveTimer);
                window._saveTimer = setTimeout(function() { ind.style.display = 'none'; }, 6000);
            }
            // Vider fournisseur, numéro facture et section saisie article
            getEl('numero_facture').value = '';
            getEl('fournisseur_input').value = '';
            getEl('fournisseur_input').classList.remove('input-matched');
            getEl('fournisseur_id').value = '';
            getEl('fournisseur_nom').value = '';
            factViderChamps();
            setTimeout(function() { getEl('fournisseur_input').focus(); }, 50);
        } else {
            alert('Erreur: ' + (result.data.message || 'Erreur inconnue'));
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i>Enregistrer (Ctrl+S)';
    })
    .catch(function(err) {
        alert('Erreur r\u00e9seau: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i>Enregistrer (Ctrl+S)';
    });
}

// =============================================
// INIT
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Devise change est géré par onDeviseChange() via onchange sur les radio buttons

        // Auto-save en-tête quand les champs changent
        var headerFields = ['numero_facture', 'date_facture', 'fournisseur_input'];
        for (var i = 0; i < headerFields.length; i++) {
            var el = getEl(headerFields[i]);
            if (el) el.addEventListener('change', factSaveState);
        }
        var notesEl = document.querySelector('input[name="notes"]');
        if (notesEl) notesEl.addEventListener('change', factSaveState);

        // Afficher les champs carton par défaut
        onSaisieTypeChange(true);

        // Restaurer le brouillon
        var restored = factLoadState();
        getEl('fournisseur_input').focus();

        console.log('✅ Facture JS OK - Articles:', FACT_ARTICLES.length, '- Catégories:', FACT_CATEGORIES.length, '- Fournisseurs:', FACT_FOURNISSEURS.length);
    } catch(err) {
        console.error('❌ Facture JS init error:', err);
    }
});
</script>
{% endblock %}
