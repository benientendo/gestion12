{% extends 'inventory/base.html' %}
{% load static l10n %}

{% block title %}Facture Fournisseur - {{ depot.nom }}{% endblock %}

{% block extra_css %}
<style>
    /* === PAGE FIXE === */
    .page-facture { height: calc(100vh - 56px); display: flex; flex-direction: column; overflow: hidden; padding: 6px 16px; }
    .facture-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 6px 16px; border-radius: 8px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
    .facture-header h5 { margin: 0; font-size: 1.1rem; }
    .facture-header .btn { padding: 5px 14px; font-size: .88rem; }
    .facture-body { flex: 1; display: flex; gap: 12px; min-height: 0; overflow: hidden; }
    .facture-left { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
    .facture-right { width: 250px; flex-shrink: 0; display: flex; flex-direction: column; }

    /* === SECTIONS === */
    .sec { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,.07); margin-bottom: 5px; }
    .sec-h { background: #f8f9fa; padding: 4px 14px; border-bottom: 1px solid #e9ecef; font-weight: 600; font-size: .9rem; display: flex; align-items: center; justify-content: space-between; }
    .sec-b { padding: 6px 14px; }

    /* === FORMULAIRE === */
    .form-label { font-size: .85rem; margin-bottom: 3px; font-weight: 600; color: #444; }
    .form-control-sm, .form-select-sm { font-size: .9rem; padding: 5px 10px; height: 36px; }
    .mb-1x { margin-bottom: 4px !important; }
    .row.gx-2 { --bs-gutter-x: 8px; }

    /* === ZONE SAISIE ARTICLE (fixe) === */
    .saisie-article { background: #eef2ff; border: 2px solid #667eea; border-radius: 8px; padding: 6px 12px; }
    .saisie-article .form-label { color: #333; }
    .carton-fields { background: #fff8e1; border-radius: 6px; padding: 5px 10px; margin-top: 3px; }
    .saisie-apercu { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
    .saisie-apercu .badge-total { background: #d4edda; color: #155724; padding: 5px 14px; border-radius: 5px; font-weight: 600; font-size: .88rem; }
    .saisie-apercu .badge-total-blue { background: #cce5ff; color: #004085; }
    .btn-ajouter-article { padding: 7px 20px; font-size: .9rem; font-weight: 600; }
    .input-matched { background: #e8f5e9 !important; border-color: #4caf50 !important; }

    /* === TABLEAU ARTICLES AJOUT√âS === */
    .table-articles-zone { flex: 1; overflow-y: auto; min-height: 0; }
    .table-articles { width: 100%; font-size: .88rem; border-collapse: collapse; }
    .table-articles thead th { background: #f8f9fa; padding: 7px 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #555; position: sticky; top: 0; font-size: .82rem; }
    .table-articles tbody td { padding: 6px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .table-articles tbody tr:hover { background: #f0f2ff; cursor: pointer; }
    .table-articles tbody tr { transition: background 0.15s ease; }
    .table-articles tbody tr:active { background: #e0e7ff; }
    .table-articles .text-end { text-align: right; }
    .table-articles .btn-sm { padding: 3px 8px; font-size: .78rem; }
    .table-articles-zone:empty::before { content: "Aucun article ajout√©. Saisissez un article ci-dessus puis cliquez Ajouter ou appuyez sur Entr√©e."; display: block; text-align: center; padding: 24px; color: #999; font-style: italic; font-size: .88rem; }

    /* === R√âSUM√â === */
    .resume-row { display: flex; justify-content: space-between; font-size: .9rem; padding: 4px 0; }
    .total-box { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: #fff; padding: 12px 14px; border-radius: 8px; text-align: right; }
    .total-box h4 { margin: 0; font-size: 1.4rem; }
    .total-box small { font-size: .78rem; }
    .btn-save { font-size: .95rem; padding: 8px 14px; }

    /* === FOCUS === */
    .form-control-sm:focus, .form-select-sm:focus { box-shadow: 0 0 0 3px rgba(102,126,234,.4); border-color: #667eea; }
    
    /* === CURSEUR AM√âLIOR√â AVEC FL√àCHES === */
    .saisie-article input, .saisie-article select {
        caret-color: #667eea;
        transition: all 0.2s ease;
        position: relative;
    }
    .saisie-article .col-2, .saisie-article .col-auto, .saisie-article .col-3 {
        position: relative;
    }
    .saisie-article input:focus, .saisie-article select:focus {
        background: #f8f9ff !important;
        border-width: 2px;
        outline: none;
    }
    .saisie-article input[type="number"]:focus {
        font-weight: 600;
    }
    .saisie-article input::placeholder {
        color: #adb5bd;
        font-style: italic;
    }
    /* Fl√®ches indicatrices */
    .saisie-article input:focus ~ .field-arrow-left,
    .saisie-article select:focus ~ .field-arrow-left,
    .saisie-article input:focus ~ .field-arrow-right,
    .saisie-article select:focus ~ .field-arrow-right {
        opacity: 1;
    }
    .field-arrows {
        position: relative;
    }
    .field-arrows::before, .field-arrows::after {
        content: '';
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border: 6px solid transparent;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }
    .field-arrows::before {
        left: -14px;
        border-right-color: #667eea;
        border-left: none;
    }
    .field-arrows::after {
        right: -14px;
        border-left-color: #667eea;
        border-right: none;
    }
    .field-arrows:focus-within::before,
    .field-arrows:focus-within::after {
        opacity: 1;
    }
    
    /* === NAVIGATION ENTER - HIGHLIGHT === */
    @keyframes fieldPulse {
        0% { box-shadow: 0 0 0 0 rgba(102,126,234,0.7); transform: scale(1); }
        50% { box-shadow: 0 0 0 8px rgba(102,126,234,0); transform: scale(1.02); }
        100% { box-shadow: 0 0 0 0 rgba(102,126,234,0); transform: scale(1); }
    }
    .field-highlight {
        animation: fieldPulse 0.4s ease-out;
        border-color: #667eea !important;
        background: #eef2ff !important;
    }

    /* === CONVERSION === */
    .conv-info { font-size: .78rem; color: #17a2b8; }

    /* === HINTS ANCIEN PRIX === */
    .hint-prev { display: none; font-size: .74rem; color: #6c757d; margin-top: 2px; line-height: 1.2; cursor: pointer; }
    .hint-prev .hint-val { background: #e3f2fd; color: #1565c0; padding: 1px 5px; border-radius: 3px; font-weight: 600; }
    .hint-prev:hover .hint-val { background: #bbdefb; }
    .hint-prev.visible { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="page-facture">
    <div class="facture-header">
        <h5><i class="fas fa-file-invoice me-1"></i>Facture Fournisseur &mdash; {{ depot.nom }}</h5>
        <a href="{% url 'inventory:detail_depot' depot.id %}" class="btn btn-light btn-sm"><i class="fas fa-arrow-left"></i> Retour</a>
    </div>

    <form method="post" id="factureForm" onsubmit="return validerFormulaire()" class="facture-body">
        {% csrf_token %}
        <input type="hidden" name="articles_json" id="articles_json" value="[]">

        <div class="facture-left">
            <!-- Infos facture -->
            <div class="sec">
                <div class="sec-h"><span><i class="fas fa-info-circle me-1"></i>Informations de la facture</span></div>
                <div class="sec-b">
                    <div class="row gx-2 align-items-end">
                        <div class="col-4 mb-1x">
                            <label class="form-label">Fournisseur <small class="text-muted fw-normal">(tapez pour rechercher ou cr√©er)</small></label>
                            <input type="text" class="form-control form-control-sm nav-field" id="fournisseur_input" list="datalistFournisseurs" placeholder="Nom du fournisseur" autocomplete="off" oninput="onFournisseurInput()" autofocus>
                            <input type="hidden" name="fournisseur_id" id="fournisseur_id" value="">
                            <input type="hidden" name="fournisseur_nom" id="fournisseur_nom" value="">
                        </div>
                        <div class="col-3 mb-1x">
                            <label class="form-label">Num√©ro de facture *</label>
                            <input type="text" class="form-control form-control-sm nav-field" name="numero_facture" id="numero_facture" required placeholder="Ex: FACT-001">
                        </div>
                        <div class="col-2 mb-1x">
                            <label class="form-label">Date facture *</label>
                            <input type="date" class="form-control form-control-sm nav-field" name="date_facture" id="date_facture" value="{{ today }}" required>
                        </div>
                        <div class="col-3 mb-1x">
                            <label class="form-label">Devise</label>
                            <div class="d-flex gap-3 mt-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="devise" id="devise_cdf" value="CDF" checked onchange="onDeviseChange()">
                                    <label class="form-check-label fw-semibold" for="devise_cdf" style="font-size:.85rem;">FC <small class="text-muted">Franc</small></label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="devise" id="devise_usd" value="USD" onchange="onDeviseChange()">
                                    <label class="form-check-label fw-semibold" for="devise_usd" style="font-size:.85rem;">$ <small class="text-muted">Dollar</small></label>
                                </div>
                            </div>
                            <input type="hidden" id="taux_dollar" value="{{ depot.taux_dollar }}">
                        </div>
                    </div>
                    <div class="row gx-2 align-items-end">
                        <div class="col mb-1x">
                            <input type="text" class="form-control form-control-sm nav-field" name="notes" placeholder="Notes (optionnel)" style="height:36px;">
                        </div>
                        <div class="col-auto mb-1x" id="info_conversion" style="display:none;">
                            <span class="conv-info"><i class="fas fa-exchange-alt"></i> 1$ = <span id="taux_affiche">{{ depot.taux_dollar|floatformat:0 }}</span> FC</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone saisie article (FIXE) -->
            <div class="sec">
                <div class="sec-h">
                    <span><i class="fas fa-edit me-1"></i>Saisir un article</span>
                    <span class="text-muted" style="font-weight:normal;font-size:.68rem;">Remplissez puis Enter ou cliquez Ajouter</span>
                </div>
                <div class="sec-b saisie-article">
                    <div class="row gx-2 align-items-end">
                        <div class="col-3 mb-1x field-arrows">
                            <label class="form-label">Nom de l'article *</label>
                            <input type="text" class="form-control form-control-sm art-field" id="art_nom" list="datalistArticles" placeholder="Tapez pour chercher ou cr√©er" autocomplete="off" oninput="onSaisieArticleInput()" onchange="onSaisieArticleInput()">
                            <input type="hidden" id="art_id" value="">
                            <input type="hidden" id="art_code" value="">
                        </div>
                        <div class="col-2 mb-1x field-arrows">
                            <label class="form-label">Cat√©gorie</label>
                            <input type="text" class="form-control form-control-sm art-field" id="art_categorie" list="datalistCategories" placeholder="Tapez pour rechercher ou cr√©er" autocomplete="off" oninput="onSaisieCategorieInput()">
                            <input type="hidden" id="art_categorie_id" value="">
                            <input type="hidden" id="art_categorie_nom" value="">
                        </div>
                        <div class="col-auto mb-1x">
                            <label class="form-label">Mode</label>
                            <div id="autoModeIndicator" style="padding:5px 12px;border-radius:6px;font-size:.8rem;font-weight:700;text-align:center;min-width:80px;background:#e3f2fd;color:#1565c0;border:1px solid #90caf9;">üì¶ Carton</div>
                            <input type="hidden" id="art_type" value="CARTON">
                        </div>
                    </div>
                    <!-- Ligne carton (toujours visible) -->
                    <div class="row gx-2 align-items-end" id="cartonFields">
                        <div class="col mb-1x"><label class="form-label">Nb. cartons</label><input type="number" class="form-control form-control-sm art-field" id="art_nb_cartons" min="0" value="0" oninput="calculerSaisie()"><div class="hint-prev" id="hint_nb_cartons" onclick="applyHint('art_nb_cartons',this)">avant: <span class="hint-val"></span></div></div>
                        <div class="col mb-1x"><label class="form-label">Pi√®ces/carton</label><input type="number" class="form-control form-control-sm art-field" id="art_pcs_carton" min="1" value="1" oninput="calculerSaisie()"><div class="hint-prev" id="hint_pcs_carton" onclick="applyHint('art_pcs_carton',this)">avant: <span class="hint-val"></span></div></div>
                        <div class="col mb-1x"><label class="form-label">Pi√®ces en +</label><input type="number" class="form-control form-control-sm art-field" id="art_pcs_sup" min="0" value="0" oninput="calculerSaisie()"></div>
                        <div class="col mb-1x"><label class="form-label">Prix/carton</label><input type="number" class="form-control form-control-sm art-field" id="art_prix_carton" min="0" step="0.01" value="0" oninput="calculerSaisie()"><div class="hint-prev" id="hint_prix_carton" onclick="applyHint('art_prix_carton',this)">avant: <span class="hint-val"></span></div></div>
                    </div>
                    <!-- Quantit√© + Prix (toujours visible) -->
                    <div class="row gx-2 align-items-end">
                        <div class="col-1 mb-1x field-arrows">
                            <label class="form-label">Quantit√© *</label>
                            <input type="number" class="form-control form-control-sm art-field" id="art_qte" min="1" value="1" oninput="calculerSaisie()">
                            <div class="hint-prev" id="hint_qte" onclick="applyHint('art_qte',this)">stock: <span class="hint-val"></span></div>
                        </div>
                        <div class="col-2 mb-1x field-arrows">
                            <label class="form-label">Prix d'achat unit. *</label>
                            <input type="number" class="form-control form-control-sm art-field" id="art_prix_achat" min="0" step="0.01" value="0" oninput="calculerSaisie()">
                            <div class="hint-prev" id="hint_prix_achat" onclick="applyHint('art_prix_achat',this)">avant: <span class="hint-val"></span></div>
                        </div>
                        <div class="col-auto mb-1x" id="prixAchatFC" style="display:none;">
                            <label class="form-label" style="color:#e65100;font-weight:700;">√âquiv. FC</label>
                            <div style="background:#fff3e0;border:2px solid #ff9800;border-radius:6px;padding:5px 14px;font-size:1.1rem;font-weight:800;color:#e65100;min-width:120px;text-align:center;" id="prixAchatFCVal">0 FC</div>
                        </div>
                        <div class="col-2 mb-1x field-arrows">
                            <label class="form-label" style="color:#198754;font-weight:600;">Prix de vente (FC)</label>
                            <input type="number" class="form-control form-control-sm art-field" id="art_prix_vente" min="0" step="0.01" value="0" oninput="calculerSaisie()" style="border-color:#4caf50;">
                            <div class="hint-prev" id="hint_prix_vente" onclick="applyHint('art_prix_vente',this)">avant: <span class="hint-val"></span></div>
                        </div>
                        <div class="col-auto mb-1x" id="beneficeDisplay">
                            <label class="form-label" style="color:#9c27b0;font-weight:600;">B√©n√©fice/pi√®ce</label>
                            <div style="background:#f3e5f5;border:2px solid #9c27b0;border-radius:6px;padding:5px 10px;font-size:0.9rem;font-weight:700;min-width:130px;text-align:center;">
                                <span id="beneficeFC" style="color:#7b1fa2;">0 FC</span>
                                <span style="color:#999;margin:0 4px;">|</span>
                                <span id="beneficePct" style="color:#4caf50;">0%</span>
                            </div>
                        </div>
                    </div>
                    <!-- Aper√ßu + bouton ajouter -->
                    <div class="saisie-apercu">
                        <div>
                            <span class="badge-total badge-total-blue" id="saisieTotal">Sous-total: 0</span>
                            <span class="conv-info" id="saisieConversion" style="display:none;margin-left:6px;">(<span id="saisieTotalConv">0</span> FC)</span>
                        </div>
                        <button type="button" class="btn btn-success btn-ajouter-article" onclick="ajouterArticle()" title="Ajouter cet article √† la facture">
                            <i class="fas fa-plus me-1"></i>Ajouter
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="askDeepSeekSuggestions()" title="Rechercher articles similaires" id="deepseekBtn">
                            <i class="fas fa-search me-1"></i>Rechercher
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="viderFormulaireSaisie()" title="Vider le formulaire">
                            <i class="fas fa-eraser me-1"></i>Vider
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tableau articles ajout√©s -->
            <div class="sec" style="flex:1;display:flex;flex-direction:column;min-height:0;">
                <div class="sec-h">
                    <span><i class="fas fa-list me-1"></i>Articles ajout√©s (<span id="nbArticlesHeader">0</span>)</span>
                    <span id="saveIndicator" style="font-size:.7rem;color:#198754;display:none;"><i class="fas fa-check-circle me-1"></i>Brouillon sauvegard√©</span>
                </div>
                <div class="table-articles-zone" id="tableArticlesZone">
                </div>
            </div>
        </div>

        <!-- R√©sum√© √† droite -->
        <div class="facture-right">
            <div class="sec" style="flex:1;display:flex;flex-direction:column;">
                <div class="sec-h"><i class="fas fa-calculator me-1"></i>R√©sum√©</div>
                <div class="sec-b" style="flex:1;display:flex;flex-direction:column;justify-content:space-between;">
                    <div>
                        <div class="resume-row"><span>Nombre d'articles:</span><strong id="nbArticles">0</strong></div>
                        <div class="resume-row"><span>Total unit√©s:</span><strong id="totalUnites">0</strong></div>
                        <hr style="margin:5px 0;">
                        <div class="total-box">
                            <small>Montant total</small>
                            <h4 id="montantTotal">0 <span id="deviseTotal" style="font-size:.75rem;">CDF</span></h4>
                        </div>
                    </div>
                    <div class="d-grid gap-1 mt-2">
                        <button type="submit" class="btn btn-primary btn-save" id="btnEnregistrer" disabled>
                            <i class="fas fa-save me-1"></i>Enregistrer (Ctrl+S)
                        </button>
                        <a href="{% url 'inventory:liste_factures_depot' depot.id %}" class="btn btn-outline-info btn-sm" style="font-size:.72rem;"><i class="fas fa-file-invoice me-1"></i>Mes factures</a>
                        <a href="{% url 'inventory:detail_depot' depot.id %}" class="btn btn-outline-secondary btn-sm" style="font-size:.72rem;">Annuler</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Datalists -->
<datalist id="datalistFournisseurs">
    {% for f in fournisseurs %}
    <option value="{{ f.nom }}" data-id="{{ f.id }}"></option>
    {% endfor %}
</datalist>
<datalist id="datalistArticles">
    {% for art in articles_existants %}
    <option value="{{ art.nom }}"></option>
    {% endfor %}
</datalist>
<datalist id="datalistCategories">
    {% for cat in categories %}
    <option value="{{ cat.nom }}"></option>
    {% endfor %}
</datalist>
{% endblock %}

{% block extra_js %}
{% load l10n %}
<script>
// === DONN√âES DJANGO ===
{% localize off %}
var FACT_FOURNISSEURS = [
    {% for f in fournisseurs %}
    { id: {{ f.id }}, nom: "{{ f.nom|escapejs }}" },
    {% endfor %}
];
var FACT_CATEGORIES = [
    {% for cat in categories %}
    { id: {{ cat.id }}, nom: "{{ cat.nom|escapejs }}" },
    {% endfor %}
];
var FACT_ARTICLES = [
    {% for art in articles_existants %}
    { id: {{ art.id }}, nom: "{{ art.nom|escapejs }}", code: "{{ art.code|escapejs }}", prix_vente: {{ art.prix_vente|default:"0" }}, prix_achat: {{ art.prix_achat|default:"0" }}, devise: "{{ art.devise|default:'CDF' }}", stock: {{ art.quantite_stock|default:"0" }}, categorie_id: "{{ art.categorie_id|default:'' }}" },
    {% endfor %}
];

// Derni√®res donn√©es d'approvisionnement par article (carton, prix, etc.)
var FACT_DERNIERS_APPROS = {{ derniers_appros_json|safe }};
{% endlocalize %}

// === HELPERS DEVISE (radio buttons) ===
function getDevise() {
    var r = document.querySelector('input[name="devise"]:checked');
    return r ? r.value : 'CDF';
}
function setDevise(val) {
    var el = document.getElementById('devise_' + val.toLowerCase());
    if (el) el.checked = true;
}
// Variable pour tracker la devise pr√©c√©dente pendant la saisie
var factDevisePrecedente = 'CDF';

function onDeviseChange() {
    var nouvelleDevise = getDevise();
    var taux = factGetTaux();
    
    getEl('info_conversion').style.display = nouvelleDevise === 'USD' ? 'block' : 'none';
    
    // Reconvertir les prix si on a chang√© de devise ET qu'il y a des valeurs saisies
    if (factDevisePrecedente !== nouvelleDevise && taux > 0) {
        var prixAchat = parseFloat(getEl('art_prix_achat').value) || 0;
        var prixCarton = parseFloat(getEl('art_prix_carton').value) || 0;
        
        if (prixAchat > 0 || prixCarton > 0) {
            // De FC vers USD
            if (factDevisePrecedente === 'CDF' && nouvelleDevise === 'USD') {
                if (prixAchat > 0) getEl('art_prix_achat').value = Math.round((prixAchat / taux) * 100) / 100;
                if (prixCarton > 0) getEl('art_prix_carton').value = Math.round((prixCarton / taux) * 100) / 100;
            }
            // De USD vers FC
            else if (factDevisePrecedente === 'USD' && nouvelleDevise === 'CDF') {
                if (prixAchat > 0) getEl('art_prix_achat').value = Math.round(prixAchat * taux);
                if (prixCarton > 0) getEl('art_prix_carton').value = Math.round(prixCarton * taux);
            }
        }
    }
    
    factDevisePrecedente = nouvelleDevise;
    calculerSaisie();
    factRafraichirTableau();
    factMajResume();
    factSaveState();
}

// === √âTAT ===
var factArticlesAjoutes = [];
var FACT_STORAGE_KEY = 'facture_brouillon_{{ depot.id }}';

// === PERSISTANCE localStorage ===
function factSaveState() {
    try {
        var state = {
            articles: factArticlesAjoutes,
            header: {
                numero_facture: getEl('numero_facture').value,
                date_facture: getEl('date_facture').value,
                devise: getDevise(),
                fournisseur_input: getEl('fournisseur_input').value,
                fournisseur_id: getEl('fournisseur_id').value,
                fournisseur_nom: getEl('fournisseur_nom').value,
                notes: document.querySelector('input[name="notes"]').value
            },
            savedAt: new Date().toISOString()
        };
        localStorage.setItem(FACT_STORAGE_KEY, JSON.stringify(state));
        // Indicateur visuel
        var ind = getEl('saveIndicator');
        if (ind) {
            ind.style.display = 'inline';
            ind.textContent = '\u2713 Brouillon sauvegard√© (' + factArticlesAjoutes.length + ' art.)';
            clearTimeout(window._saveTimer);
            window._saveTimer = setTimeout(function() { ind.style.display = 'none'; }, 3000);
        }
        console.log('\ud83d\udcbe Sauvegard√©:', factArticlesAjoutes.length, 'articles');
    } catch(err) { console.warn('Save state error:', err); }
}

// Sauvegarder automatiquement avant de quitter la page
window.addEventListener('beforeunload', function() {
    if (factArticlesAjoutes.length > 0) factSaveState();
});

function factLoadState() {
    try {
        var raw = localStorage.getItem(FACT_STORAGE_KEY);
        if (!raw) return false;
        var state = JSON.parse(raw);
        if (!state || !state.articles || state.articles.length === 0) {
            // Restaurer seulement l'en-t√™te s'il y a des donn√©es
            if (state && state.header) {
                var h = state.header;
                if (h.numero_facture) getEl('numero_facture').value = h.numero_facture;
                if (h.date_facture) getEl('date_facture').value = h.date_facture;
                if (h.devise) setDevise(h.devise);
                if (h.fournisseur_input) {
                    getEl('fournisseur_input').value = h.fournisseur_input;
                    if (h.fournisseur_id) {
                        getEl('fournisseur_id').value = h.fournisseur_id;
                        getEl('fournisseur_input').classList.add('input-matched');
                    }
                    if (h.fournisseur_nom) getEl('fournisseur_nom').value = h.fournisseur_nom;
                }
                if (h.notes) document.querySelector('input[name="notes"]').value = h.notes;
            }
            return false;
        }
        // Restaurer les articles
        factArticlesAjoutes = state.articles;
        // Restaurer l'en-t√™te
        if (state.header) {
            var h = state.header;
            if (h.numero_facture) getEl('numero_facture').value = h.numero_facture;
            if (h.date_facture) getEl('date_facture').value = h.date_facture;
            if (h.devise) {
                setDevise(h.devise);
                getEl('info_conversion').style.display = h.devise === 'USD' ? 'block' : 'none';
            }
            if (h.fournisseur_input) {
                getEl('fournisseur_input').value = h.fournisseur_input;
                if (h.fournisseur_id) {
                    getEl('fournisseur_id').value = h.fournisseur_id;
                    getEl('fournisseur_input').classList.add('input-matched');
                }
                if (h.fournisseur_nom) getEl('fournisseur_nom').value = h.fournisseur_nom;
            }
            if (h.notes) document.querySelector('input[name="notes"]').value = h.notes;
        }
        factRafraichirTableau();
        factMajResume();
        var savedAt = state.savedAt ? new Date(state.savedAt) : null;
        var timeStr = savedAt ? savedAt.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) : '';
        console.log('\ud83d\udccb Brouillon restaur\u00e9: ' + factArticlesAjoutes.length + ' articles' + (timeStr ? ' (sauvegard\u00e9 \u00e0 ' + timeStr + ')' : ''));
        // Indicateur visuel de restauration
        var ind = getEl('saveIndicator');
        if (ind) {
            ind.style.display = 'inline';
            ind.style.color = '#0d6efd';
            ind.textContent = '\ud83d\udccb Restaur\u00e9: ' + factArticlesAjoutes.length + ' articles' + (timeStr ? ' (sauvegard\u00e9 \u00e0 ' + timeStr + ')' : '');
            setTimeout(function() { ind.style.display = 'none'; ind.style.color = '#198754'; }, 5000);
        }
        return true;
    } catch(err) { console.warn('Load state error:', err); return false; }
}

function factClearState() {
    try { localStorage.removeItem(FACT_STORAGE_KEY); } catch(err) {}
}

// === HELPER ===
function getEl(id) { return document.getElementById(id); }
function factFormatNumber(n) { return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 2 }).format(n); }
function factGetTaux() { return parseFloat(getEl('taux_dollar').value) || 2800; }
function factEscapeHtml(str) { var d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

// === ARTICLE S√âLECTIONN√â (pour hints) ===
var factSelectedArticle = null;

function showHint(hintId, value, devise) {
    var el = getEl(hintId);
    if (!el) return;
    var span = el.querySelector('.hint-val');
    if (span) span.textContent = factFormatNumber(value) + (devise ? ' ' + devise : '');
    el.classList.add('visible');
    el.dataset.hintValue = value;
}

function hideAllHints() {
    var hints = document.querySelectorAll('.hint-prev');
    for (var i = 0; i < hints.length; i++) {
        hints[i].classList.remove('visible');
        hints[i].dataset.hintValue = '';
    }
    factSelectedArticle = null;
}

function applyHint(fieldId, hintEl) {
    var val = hintEl.dataset.hintValue;
    if (val !== undefined && val !== '') {
        getEl(fieldId).value = val;
        calculerSaisie();
    }
}

// === AVERTISSEMENT DEVISE ===
function showDeviseWarning(articleNom, devisePrecedente, deviseActuelle) {
    var container = getEl('deviseWarningContainer');
    if (!container) {
        // Cr√©er le container s'il n'existe pas
        container = document.createElement('div');
        container.id = 'deviseWarningContainer';
        container.style.cssText = 'margin:8px 0;padding:10px 12px;background:linear-gradient(135deg,#fff3cd,#ffeaa7);border:1px solid #f39c12;border-radius:6px;font-size:0.85rem;display:none;';
        var saisieZone = document.querySelector('.saisie-zone');
        if (saisieZone) saisieZone.insertBefore(container, saisieZone.firstChild);
    }
    container.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-2"></i>' +
        '<strong>Attention:</strong> L\'article "<b>' + articleNom + '</b>" a √©t√© enregistr√© en <b>' + devisePrecedente + '</b>. ' +
        'Vous saisissez maintenant en <b>' + deviseActuelle + '</b>. Les prix ont √©t√© convertis automatiquement.';
    container.style.display = 'block';
}

function hideDeviseWarning() {
    var container = getEl('deviseWarningContainer');
    if (container) container.style.display = 'none';
}

// =============================================
// NAVIGATION ENTER
// =============================================
function factGetVisibleFields() {
    var type = getAutoType();
    var all = document.querySelectorAll('.nav-field, .art-field');
    var result = [];
    for (var i = 0; i < all.length; i++) {
        var f = all[i];
        if (f.offsetParent === null) continue;
        // En mode carton, sauter le champ quantit√© (auto-calcul√©)
        if (type === 'CARTON' && f.id === 'art_qte') continue;
        // En mode pi√®ce, sauter les champs carton sauf nb_cartons (pour pouvoir y taper)
        if (type !== 'CARTON' && (f.id === 'art_pcs_carton' || f.id === 'art_pcs_sup' || f.id === 'art_prix_carton')) continue;
        result.push(f);
    }
    return result;
}

document.addEventListener('keydown', function(e) {
    try {
        if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
            e.preventDefault();
            soumettreFactureAjax();
            return;
        }
        if (e.key !== 'Enter') return;
        var el = document.activeElement;
        if (!el) return;
        if (el.tagName === 'BUTTON' || el.type === 'submit') return;
        e.preventDefault();

        // Si c'est un radio button, passer au premier champ article
        if (el.type === 'radio') {
            var artNom = getEl('art_nom');
            if (artNom) { artNom.focus(); artNom.select(); }
            return;
        }

        var fields = factGetVisibleFields();
        var idx = -1;
        for (var i = 0; i < fields.length; i++) {
            if (fields[i] === el) { idx = i; break; }
        }
        if (idx < 0) return;

        if (idx === fields.length - 1 && el.classList.contains('art-field')) {
            ajouterArticle();
            return;
        }
        if (idx < fields.length - 1) {
            var nextField = fields[idx + 1];
            nextField.focus();
            if (nextField.select) nextField.select();
            // Effet visuel de highlight
            nextField.classList.add('field-highlight');
            setTimeout(function() { nextField.classList.remove('field-highlight'); }, 400);
        }
    } catch(err) { console.error('Enter nav error:', err); }
});

// =============================================
// VIDER FORMULAIRE SAISIE
// =============================================
function viderFormulaireSaisie() {
    getEl('art_nom').value = '';
    factResetArticleFields();
    calculerSaisie();
    getEl('art_nom').focus();
}

// =============================================
// AUTOCOMPLETE ARTICLE
// =============================================
function factResetArticleFields() {
    factSelectedArticle = null;
    getEl('art_id').value = '';
    getEl('art_code').value = '';
    getEl('art_nom').classList.remove('input-matched');
    getEl('art_categorie').value = '';
    getEl('art_categorie').classList.remove('input-matched');
    getEl('art_categorie_id').value = '';
    getEl('art_categorie_nom').value = '';
    getEl('art_nb_cartons').value = '0';
    getEl('art_pcs_carton').value = '1';
    getEl('art_pcs_sup').value = '0';
    getEl('art_prix_carton').value = '0';
    getEl('art_qte').value = '1';
    getEl('art_prix_achat').value = '0';
    getEl('art_prix_vente').value = '0';
    getEl('prixAchatFC').style.display = 'none';
    updateModeIndicator();
    hideAllHints();
    hideDeviseWarning();
    getEl('saisieTotal').textContent = 'Sous-total: 0';
    getEl('saisieConversion').style.display = 'none';
}

function onSaisieArticleInput() {
    try {
        var input = getEl('art_nom');
        var val = input.value.trim();

        // Si le champ est vide, tout r√©initialiser imm√©diatement
        if (!val) {
            factResetArticleFields();
            return;
        }

        var match = null;
        for (var i = 0; i < FACT_ARTICLES.length; i++) {
            if (FACT_ARTICLES[i].nom.toLowerCase() === val.toLowerCase()) { match = FACT_ARTICLES[i]; break; }
        }
        if (match) {
            factSelectedArticle = match;
            getEl('art_id').value = match.id;
            getEl('art_code').value = match.code;
            input.classList.add('input-matched');

            // Cat√©gorie
            if (match.categorie_id) {
                for (var j = 0; j < FACT_CATEGORIES.length; j++) {
                    if (String(FACT_CATEGORIES[j].id) === String(match.categorie_id)) {
                        getEl('art_categorie').value = FACT_CATEGORIES[j].nom;
                        getEl('art_categorie_id').value = FACT_CATEGORIES[j].id;
                        getEl('art_categorie_nom').value = '';
                        getEl('art_categorie').classList.add('input-matched');
                        break;
                    }
                }
            }

            var appro = FACT_DERNIERS_APPROS[String(match.id)];
            
            // Les prix stock√©s sont TOUJOURS en FC
            // Si la devise actuelle est USD, on doit convertir FC ‚Üí USD
            var deviseActuelle = getDevise();
            var taux = factGetTaux();
            function prixPourChamp(prixFC) {
                if (deviseActuelle === 'USD' && taux > 0) {
                    return Math.round((prixFC / taux) * 100) / 100;
                }
                return prixFC;
            }
            
            // Avertissement si devise diff√©rente de la derni√®re facture
            if (appro && appro.devise_saisie) {
                var deviseAppro = appro.devise_saisie === 'USD' ? 'USD' : 'CDF';
                if (deviseAppro !== deviseActuelle) {
                    var msgDevise = deviseAppro === 'USD' ? 'Dollar (USD)' : 'Franc Congolais (FC)';
                    var msgActuel = deviseActuelle === 'USD' ? 'Dollar (USD)' : 'Franc Congolais (FC)';
                    showDeviseWarning(match.nom, msgDevise, msgActuel);
                } else {
                    hideDeviseWarning();
                }
            }

            // Si derni√®re facture √©tait en carton, pr√©-remplir les champs carton
            if (appro && appro.type_quantite === 'CARTON') {
                if (appro.nombre_cartons > 0) {
                    getEl('art_nb_cartons').value = appro.nombre_cartons;
                    showHint('hint_nb_cartons', appro.nombre_cartons, 'crt');
                }
                if (appro.pieces_par_carton > 0) {
                    getEl('art_pcs_carton').value = appro.pieces_par_carton;
                    showHint('hint_pcs_carton', appro.pieces_par_carton, 'pcs');
                }
                if (appro.prix_achat_carton > 0) {
                    getEl('art_prix_carton').value = prixPourChamp(appro.prix_achat_carton);
                    showHint('hint_prix_carton', appro.prix_achat_carton, 'FC');
                }
            }

            // Pr√©-remplir prix d'achat + hint (prix stock√© en FC)
            if (appro && appro.prix_achat_unitaire > 0) {
                getEl('art_prix_achat').value = prixPourChamp(appro.prix_achat_unitaire);
                showHint('hint_prix_achat', appro.prix_achat_unitaire, 'FC');
            } else if (match.prix_achat > 0) {
                getEl('art_prix_achat').value = prixPourChamp(match.prix_achat);
                showHint('hint_prix_achat', match.prix_achat, 'FC');
            }

            // Prix de vente est toujours en FC, ne pas convertir
            if (match.prix_vente > 0) {
                getEl('art_prix_vente').value = match.prix_vente;
                showHint('hint_prix_vente', match.prix_vente, 'FC');
            }

            // Hint stock actuel
            showHint('hint_qte', match.stock, '');

            calculerSaisie();
        } else {
            factResetArticleFields();
        }
    } catch(err) { console.error('Article input error:', err); }
}

// =============================================
// AUTOCOMPLETE CAT√âGORIE
// =============================================
function onSaisieCategorieInput() {
    try {
        var input = getEl('art_categorie');
        var val = input.value.trim();
        var match = null;
        for (var i = 0; i < FACT_CATEGORIES.length; i++) {
            if (FACT_CATEGORIES[i].nom.toLowerCase() === val.toLowerCase()) { match = FACT_CATEGORIES[i]; break; }
        }
        if (match) {
            getEl('art_categorie_id').value = match.id;
            getEl('art_categorie_nom').value = '';
            input.classList.add('input-matched');
        } else {
            getEl('art_categorie_id').value = '';
            getEl('art_categorie_nom').value = val;
            input.classList.remove('input-matched');
        }
    } catch(err) { console.error('Categorie input error:', err); }
}

// =============================================
// AUTO-D√âTECTION TYPE QUANTIT√â
// =============================================
function getAutoType() {
    var nc = parseInt(getEl('art_nb_cartons').value) || 0;
    return nc > 0 ? 'CARTON' : 'UNITE';
}

function updateModeIndicator() {
    var type = getAutoType();
    var ind = getEl('autoModeIndicator');
    var qteInput = getEl('art_qte');
    getEl('art_type').value = type;
    if (type === 'CARTON') {
        ind.textContent = 'üì¶ Carton';
        ind.style.background = '#e3f2fd'; ind.style.color = '#1565c0'; ind.style.borderColor = '#90caf9';
        qteInput.readOnly = true;
        qteInput.style.background = '#e9ecef';
    } else {
        ind.textContent = 'üî¢ Pi√®ce';
        ind.style.background = '#f3e5f5'; ind.style.color = '#7b1fa2'; ind.style.borderColor = '#ce93d8';
        qteInput.readOnly = false;
        qteInput.style.background = '';
    }
}

function onSaisieTypeChange(skipFocus) {
    updateModeIndicator();
    calculerSaisie();
}

// =============================================
// CALCUL APER√áU
// =============================================
function calculerSaisie() {
    try {
        // Auto-d√©tection du mode
        updateModeIndicator();
        var type = getAutoType();
        var devise = getDevise();
        var total = 0, qteUnites = 0;
        if (type === 'CARTON') {
            var nc = parseFloat(getEl('art_nb_cartons').value) || 0;
            var ppc = parseFloat(getEl('art_pcs_carton').value) || 1;
            var ps = parseFloat(getEl('art_pcs_sup').value) || 0;
            var pc = parseFloat(getEl('art_prix_carton').value) || 0;
            var pu = ppc > 0 ? pc / ppc : 0;
            var pps = pu;
            qteUnites = (nc * ppc) + ps;
            total = (nc * pc) + (ps * pps);
            // Synchroniser quantit√© et prix d'achat unitaire calcul√©s
            getEl('art_qte').value = qteUnites;
            getEl('art_prix_achat').value = Math.round(pu * 100) / 100;
        } else {
            qteUnites = parseFloat(getEl('art_qte').value) || 0;
            var pa = parseFloat(getEl('art_prix_achat').value) || 0;
            total = qteUnites * pa;
        }
        getEl('saisieTotal').textContent = 'Sous-total: ' + factFormatNumber(total) + (type === 'CARTON' ? ' (' + qteUnites + ' unit√©s)' : '');
        // Afficher l'√©quivalent FC du prix d'achat unitaire
        var taux = factGetTaux();
        var pa_unit = parseFloat(getEl('art_prix_achat').value) || 0;
        if (devise === 'USD' && pa_unit > 0) {
            getEl('prixAchatFCVal').textContent = factFormatNumber(pa_unit * taux) + ' FC';
            getEl('prixAchatFC').style.display = '';
        } else {
            getEl('prixAchatFC').style.display = 'none';
        }
        // Prix de vente toujours en FC, pas de conversion n√©cessaire
        if (devise === 'USD' && total > 0) {
            getEl('saisieTotalConv').textContent = factFormatNumber(total * factGetTaux());
            getEl('saisieConversion').style.display = 'inline';
        } else {
            getEl('saisieConversion').style.display = 'none';
        }
        
        // Calcul du b√©n√©fice (prix de vente en FC - prix d'achat converti en FC)
        var prixVente = parseFloat(getEl('art_prix_vente').value) || 0;
        var prixAchatFC = pa_unit;
        if (devise === 'USD' && taux > 0) {
            prixAchatFC = pa_unit * taux; // Convertir USD en FC
        }
        var beneficeFC = prixVente - prixAchatFC;
        var beneficePct = prixAchatFC > 0 ? ((beneficeFC / prixAchatFC) * 100) : 0;
        
        // Afficher le b√©n√©fice avec couleur selon positif/n√©gatif
        var elBeneficeFC = getEl('beneficeFC');
        var elBeneficePct = getEl('beneficePct');
        if (elBeneficeFC && elBeneficePct) {
            elBeneficeFC.textContent = factFormatNumber(Math.round(beneficeFC)) + ' FC';
            elBeneficePct.textContent = (beneficePct >= 0 ? '+' : '') + Math.round(beneficePct) + '%';
            // Couleur: vert si positif, rouge si n√©gatif
            elBeneficeFC.style.color = beneficeFC >= 0 ? '#4caf50' : '#f44336';
            elBeneficePct.style.color = beneficePct >= 0 ? '#4caf50' : '#f44336';
        }
    } catch(err) { console.error('Calcul error:', err); }
}

// =============================================
// AJOUTER ARTICLE
// =============================================
function ajouterArticle() {
    try {
        var nom = getEl('art_nom').value.trim();
        if (!nom) { alert('Saisissez le nom de l\'article'); getEl('art_nom').focus(); return; }

        var type = getAutoType();
        var art = {
            article_id: getEl('art_id').value || null,
            code: getEl('art_code').value || '',
            nom: nom,
            description: '',
            categorie_id: getEl('art_categorie_id').value || (factSelectedArticle ? factSelectedArticle.categorie_id : null) || null,
            categorie_nom: getEl('art_categorie_nom').value || '',
            type_quantite: type
        };

        art.prix_vente = parseFloat(getEl('art_prix_vente').value) || 0;

        if (type === 'CARTON') {
            art.nombre_cartons = parseInt(getEl('art_nb_cartons').value) || 0;
            art.pieces_par_carton = parseInt(getEl('art_pcs_carton').value) || 1;
            art.pieces_supplementaires = parseInt(getEl('art_pcs_sup').value) || 0;
            art.prix_achat_carton = parseFloat(getEl('art_prix_carton').value) || 0;
            art.prix_achat_unitaire = art.pieces_par_carton > 0 ? art.prix_achat_carton / art.pieces_par_carton : 0;
            art.prix_piece_sup = art.prix_achat_unitaire;
            art.quantite_unites = (art.nombre_cartons * art.pieces_par_carton) + art.pieces_supplementaires;
        } else {
            art.quantite_unites = parseInt(getEl('art_qte').value) || 0;
            art.prix_achat_unitaire = parseFloat(getEl('art_prix_achat').value) || 0;
            art.nombre_cartons = 0;
            art.pieces_par_carton = 1;
            art.prix_achat_carton = 0;
        }

        if (art.quantite_unites <= 0) { alert('La quantit√© doit √™tre sup√©rieure √† 0'); return; }

        // Conversion USD ‚Üí FC si devise Dollar
        if (getDevise() === 'USD') {
            var taux = factGetTaux();
            art.prix_achat_unitaire = Math.round(art.prix_achat_unitaire * taux * 100) / 100;
            art.prix_achat_carton = Math.round(art.prix_achat_carton * taux * 100) / 100;
                        // prix_vente reste en FC (la vente s'effectue toujours en FC)
        }

        factArticlesAjoutes.unshift(art);
        factViderChamps();
        factRafraichirTableau();
        factMajResume();
        factSaveState();
        setTimeout(function() { getEl('art_nom').focus(); getEl('art_nom').select(); }, 100);
    } catch(err) { console.error('Ajouter article error:', err); alert('Erreur: ' + err.message); }
}

// =============================================
// VIDER LES CHAMPS
// =============================================
function factViderChamps() {
    getEl('art_nom').value = '';
    getEl('art_nom').classList.remove('input-matched');
    getEl('art_id').value = '';
    getEl('art_code').value = '';
    getEl('art_categorie').value = '';
    getEl('art_categorie').classList.remove('input-matched');
    getEl('art_categorie_id').value = '';
    getEl('art_categorie_nom').value = '';
    getEl('art_nb_cartons').value = '0';
    getEl('art_pcs_carton').value = '1';
    getEl('art_pcs_sup').value = '0';
    getEl('art_prix_carton').value = '0';
    getEl('art_qte').value = '1';
    getEl('art_prix_achat').value = '0';
    getEl('art_prix_vente').value = '0';
    getEl('saisieTotal').textContent = 'Sous-total: 0';
    getEl('saisieConversion').style.display = 'none';
    getEl('prixAchatFC').style.display = 'none';
    updateModeIndicator();
    hideAllHints();
}

// =============================================
// TABLEAU
// =============================================
function factRafraichirTableau() {
    var zone = getEl('tableArticlesZone');
    if (factArticlesAjoutes.length === 0) { zone.innerHTML = ''; return; }
    var html = '<table class="table-articles"><thead><tr>';
    html += '<th>#</th><th>Article</th><th>Type</th><th class="text-end">Qt√©</th>';
    html += '<th class="text-end" style="color:#0d6efd;">P.A. Unit.</th>';
    html += '<th class="text-end" style="color:#0d6efd;">Total Achat</th>';
    html += '<th class="text-end" style="color:#198754;">P.V. Unit. (FC)</th>';
    html += '<th class="text-end" style="color:#198754;">Total Vente (FC)</th>';
    html += '<th></th>';
    html += '</tr></thead><tbody>';
    for (var i = 0; i < factArticlesAjoutes.length; i++) {
        var a = factArticlesAjoutes[i];
        var totalAchat = a.type_quantite === 'CARTON'
            ? (a.nombre_cartons * a.prix_achat_carton) + (a.pieces_supplementaires * (a.prix_piece_sup || a.prix_achat_unitaire))
            : a.quantite_unites * a.prix_achat_unitaire;
        var totalVente = a.quantite_unites * a.prix_vente;
        var typeLabel = a.type_quantite === 'CARTON' ? a.nombre_cartons + ' crt (' + a.quantite_unites + ' pcs)' : 'Unit√©';
        var prixAchat = a.prix_achat_unitaire;
        html += '<tr ondblclick="factEditerLigne(' + i + ')" title="Double-clic pour √©diter">';
        html += '<td>' + (i + 1) + '</td>';
        html += '<td><strong id="nom_art_' + i + '">' + factEscapeHtml(a.nom) + '</strong>' + (a.article_id ? ' <span class="badge bg-success" style="font-size:.55rem;">existant</span>' : ' <span class="badge bg-warning text-dark" style="font-size:.55rem;">nouveau</span>') + ' <button type="button" class="btn btn-link btn-sm p-0 ms-1" onclick="factModifierNomArticle(' + i + ')" title="Modifier le nom" tabindex="-1"><i class="fas fa-pen" style="font-size:.65rem;color:#6c757d;"></i></button></td>';
        html += '<td>' + typeLabel + '</td>';
        html += '<td class="text-end">' + a.quantite_unites + '</td>';
        html += '<td class="text-end" style="color:#0d6efd;">' + factFormatNumber(prixAchat) + '</td>';
        html += '<td class="text-end" style="color:#0d6efd;"><strong>' + factFormatNumber(totalAchat) + '</strong></td>';
        html += '<td class="text-end" style="color:#198754;">' + factFormatNumber(a.prix_vente) + '</td>';
        html += '<td class="text-end" style="color:#198754;"><strong>' + factFormatNumber(totalVente) + '</strong></td>';
        html += '<td><button type="button" class="btn btn-outline-danger btn-sm" onclick="factSupprimerArticle(' + i + ')" tabindex="-1"><i class="fas fa-trash"></i></button></td>';
        html += '</tr>';
    }
    html += '</tbody></table>';
    zone.innerHTML = html;
}

function factSupprimerArticle(index) {
    try {
        if (index < 0 || index >= factArticlesAjoutes.length) { console.warn('Index invalide:', index); return; }
        var nom = factArticlesAjoutes[index].nom || 'Article';
        if (!confirm('Supprimer "' + nom + '" de la liste ?')) return;
        factArticlesAjoutes.splice(index, 1);
        factRafraichirTableau();
        factMajResume();
        factSaveState();
    } catch(err) { console.error('Supprimer article error:', err); alert('Erreur suppression: ' + err.message); }
}

// Double-clic sur une ligne pour l'√©diter dans le formulaire
function factEditerLigne(index) {
    try {
        if (index < 0 || index >= factArticlesAjoutes.length) return;
        var a = factArticlesAjoutes[index];
        
        // Remplir le formulaire avec les donn√©es de la ligne
        getEl('art_nom').value = a.nom;
        getEl('art_id').value = a.article_id || '';
        getEl('art_code').value = a.code || '';
        if (a.article_id) {
            getEl('art_nom').classList.add('input-matched');
        }
        
        // Cat√©gorie
        getEl('art_categorie').value = a.categorie_nom || '';
        getEl('art_categorie_id').value = a.categorie_id || '';
        getEl('art_categorie_nom').value = a.categorie_nom_custom || '';
        if (a.categorie_id) {
            getEl('art_categorie').classList.add('input-matched');
        }
        
        // Type et champs carton
        getEl('art_type').value = a.type_quantite || 'UNITE';
        getEl('art_nb_cartons').value = a.nombre_cartons || 0;
        getEl('art_pcs_carton').value = a.pieces_par_carton || 1;
        getEl('art_pcs_sup').value = a.pieces_supplementaires || 0;
        getEl('art_prix_carton').value = a.prix_achat_carton || 0;
        
        // Quantit√© et prix
        getEl('art_qte').value = a.quantite_unites || 1;
        getEl('art_prix_achat').value = a.prix_achat_unitaire || 0;
        getEl('art_prix_vente').value = a.prix_vente || 0;
        
        // Mettre √† jour l'indicateur de mode
        updateModeIndicator();
        
        // Recalculer l'aper√ßu
        calculerSaisie();
        
        // Supprimer la ligne de la liste
        factArticlesAjoutes.splice(index, 1);
        factRafraichirTableau();
        factMajResume();
        factSaveState();
        
        // Focus sur le premier champ modifiable (quantit√©)
        getEl('art_qte').focus();
        getEl('art_qte').select();
        
        // Feedback visuel
        getEl('art_nom').classList.add('field-highlight');
        setTimeout(function() { getEl('art_nom').classList.remove('field-highlight'); }, 500);
        
    } catch(err) { console.error('Editer ligne error:', err); alert('Erreur √©dition: ' + err.message); }
}

function factModifierNomArticle(index) {
    try {
        if (index < 0 || index >= factArticlesAjoutes.length) return;
        var article = factArticlesAjoutes[index];
        // Ouvrir le modal moderne
        document.getElementById('modalNomIndex').value = index;
        document.getElementById('modalNomInput').value = article.nom;
        var modal = new bootstrap.Modal(document.getElementById('modalModifierNom'));
        modal.show();
        // Focus sur l'input apr√®s ouverture
        setTimeout(function() {
            var input = document.getElementById('modalNomInput');
            input.focus();
            input.select();
        }, 300);
    } catch(err) { console.error('Modifier nom article error:', err); }
}

function validerModifNom() {
    try {
        var index = parseInt(document.getElementById('modalNomIndex').value);
        var nouveauNom = document.getElementById('modalNomInput').value.trim();
        if (index < 0 || index >= factArticlesAjoutes.length) return;
        if (nouveauNom === '') {
            document.getElementById('modalNomInput').classList.add('is-invalid');
            return;
        }
        var article = factArticlesAjoutes[index];
        article.nom = nouveauNom;
        if (!article.article_id) {
            article.nom_custom = nouveauNom;
        }
        // Fermer le modal
        bootstrap.Modal.getInstance(document.getElementById('modalModifierNom')).hide();
        factRafraichirTableau();
        factSaveState();
    } catch(err) { console.error('Valider modif nom error:', err); }
}

// =============================================
// R√âSUM√â & JSON
// =============================================
function factMajResume() {
    var totalU = 0, montant = 0;
    for (var i = 0; i < factArticlesAjoutes.length; i++) {
        var a = factArticlesAjoutes[i];
        totalU += a.quantite_unites || 0;
        if (a.type_quantite === 'CARTON') {
            montant += (a.nombre_cartons * a.prix_achat_carton) + (a.pieces_supplementaires * (a.prix_piece_sup || a.prix_achat_unitaire));
        } else {
            montant += a.quantite_unites * a.prix_achat_unitaire;
        }
    }
    var el;
    if ((el = getEl('nbArticles'))) el.textContent = factArticlesAjoutes.length;
    if ((el = getEl('nbArticlesHeader'))) el.textContent = factArticlesAjoutes.length;
    if ((el = getEl('totalUnites'))) el.textContent = totalU;
    if ((el = getEl('montantTotal'))) el.textContent = factFormatNumber(montant);
    if ((el = getEl('deviseTotal'))) el.textContent = 'FC';
    if ((el = getEl('btnEnregistrer'))) el.disabled = (factArticlesAjoutes.length === 0);
    if ((el = getEl('articles_json'))) el.value = JSON.stringify(factArticlesAjoutes);
}

// =============================================
// FOURNISSEUR
// =============================================
function onFournisseurInput() {
    try {
        var input = getEl('fournisseur_input');
        var val = input.value.trim();
        var match = null;
        for (var i = 0; i < FACT_FOURNISSEURS.length; i++) {
            if (FACT_FOURNISSEURS[i].nom.toLowerCase() === val.toLowerCase()) { match = FACT_FOURNISSEURS[i]; break; }
        }
        if (match) {
            getEl('fournisseur_id').value = match.id;
            getEl('fournisseur_nom').value = '';
            input.classList.add('input-matched');
        } else {
            getEl('fournisseur_id').value = '';
            getEl('fournisseur_nom').value = val;
            input.classList.remove('input-matched');
        }
    } catch(err) { console.error('Fournisseur error:', err); }
}

// =============================================
// VALIDATION FORMULAIRE
// =============================================
function validerFormulaire() {
    // Intercepter le submit normal et utiliser AJAX
    soumettreFactureAjax();
    return false;
}

function soumettreFactureAjax() {
    if (factArticlesAjoutes.length === 0) { alert('Veuillez ajouter au moins un article'); return; }
    if (!getEl('numero_facture').value.trim()) { alert('Le num\u00e9ro de facture est obligatoire'); getEl('numero_facture').focus(); return; }

    getEl('articles_json').value = JSON.stringify(factArticlesAjoutes);
    var btn = getEl('btnEnregistrer');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enregistrement en cours...';

    var form = getEl('factureForm');
    var formData = new FormData(form);

    fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(function(resp) { return resp.json().then(function(data) { return {ok: resp.ok, data: data}; }); })
    .then(function(result) {
        if (result.ok && result.data.success) {
            // Succ√®s: vider les articles, garder l'en-t√™te
            factArticlesAjoutes = [];
            factRafraichirTableau();
            factMajResume();
            factClearState();
            // Message succ√®s
            var ind = getEl('saveIndicator');
            if (ind) {
                ind.style.display = 'inline';
                ind.style.color = '#198754';
                ind.textContent = '\u2705 ' + result.data.message;
                clearTimeout(window._saveTimer);
                window._saveTimer = setTimeout(function() { ind.style.display = 'none'; }, 6000);
            }
            // Vider TOUS les champs: en-t√™te + article
            getEl('numero_facture').value = '';
            getEl('date_facture').value = new Date().toISOString().slice(0, 10);
            getEl('fournisseur_input').value = '';
            getEl('fournisseur_input').classList.remove('input-matched');
            getEl('fournisseur_id').value = '';
            getEl('fournisseur_nom').value = '';
            var notesField = document.querySelector('input[name="notes"]');
            if (notesField) notesField.value = '';
            factViderChamps();
            setTimeout(function() { getEl('fournisseur_input').focus(); }, 150);
        } else {
            alert('Erreur: ' + (result.data.message || 'Erreur inconnue'));
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i>Enregistrer (Ctrl+S)';
    })
    .catch(function(err) {
        alert('Erreur r\u00e9seau: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i>Enregistrer (Ctrl+S)';
    });
}

// =============================================
// INIT
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Devise change est g√©r√© par onDeviseChange() via onchange sur les radio buttons

        // Auto-save en-t√™te quand les champs changent
        var headerFields = ['numero_facture', 'date_facture', 'fournisseur_input'];
        for (var i = 0; i < headerFields.length; i++) {
            var el = getEl(headerFields[i]);
            if (el) el.addEventListener('change', factSaveState);
        }
        var notesEl = document.querySelector('input[name="notes"]');
        if (notesEl) notesEl.addEventListener('change', factSaveState);

        // Initialiser l'indicateur de mode auto
        updateModeIndicator();

        // Restaurer le brouillon
        var restored = factLoadState();
        getEl('fournisseur_input').focus();

        console.log('‚úÖ Facture JS OK - Articles:', FACT_ARTICLES.length, '- Cat√©gories:', FACT_CATEGORIES.length, '- Fournisseurs:', FACT_FOURNISSEURS.length);
    } catch(err) {
        console.error('‚ùå Facture JS init error:', err);
    }
});

// =============================================
// AUTOCOMPL√âTION INTELLIGENTE (bas√©e sur donn√©es locales)
// =============================================
function askDeepSeekSuggestions() {
    var articleName = getEl('art_nom').value.trim().toLowerCase();
    if (!articleName || articleName.length < 2) {
        alert('Veuillez saisir au moins 2 caract√®res');
        getEl('art_nom').focus();
        return;
    }
    
    // Rechercher dans les articles existants
    var matches = [];
    for (var i = 0; i < FACT_ARTICLES.length; i++) {
        var art = FACT_ARTICLES[i];
        var nomLower = art.nom.toLowerCase();
        if (nomLower.indexOf(articleName) !== -1 || articleName.indexOf(nomLower.substring(0, 3)) !== -1) {
            matches.push(art);
        }
    }
    
    if (matches.length === 0) {
        alert('Aucun article similaire trouv√© dans la base de donn√©es');
        return;
    }
    
    // Afficher les suggestions
    displayLocalSuggestions(matches.slice(0, 10));
}

function displayLocalSuggestions(articles) {
    var modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
    modal.id = 'suggestionModal';
    
    var listHtml = '';
    for (var i = 0; i < articles.length; i++) {
        var art = articles[i];
        var appro = FACT_DERNIERS_APPROS[String(art.id)] || {};
        listHtml += '<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s;" ' +
            'onmouseover="this.style.background=\'#e3f2fd\'" onmouseout="this.style.background=\'white\'" ' +
            'onclick="applyLocalSuggestion(' + art.id + ')">' +
            '<div style="font-weight:bold;color:#1565c0;">' + art.nom + '</div>' +
            '<div style="font-size:0.85em;color:#666;">' +
            'P.Achat: <b>' + (appro.prix_achat_unitaire || art.prix_achat || 0) + ' FC</b> | ' +
            'P.Vente: <b>' + (art.prix_vente || 0) + ' FC</b> | ' +
            'Stock: ' + (art.stock || 0) +
            '</div></div>';
    }
    
    modal.innerHTML = '<div style="background:white;border-radius:8px;max-width:500px;width:90%;max-height:80vh;overflow:hidden;">' +
        '<div style="padding:15px;background:#1565c0;color:white;">' +
        '<i class="fas fa-search me-2"></i>Articles similaires (' + articles.length + ')' +
        '<button type="button" onclick="document.getElementById(\'suggestionModal\').remove()" ' +
        'style="float:right;background:none;border:none;color:white;font-size:1.2em;cursor:pointer;">&times;</button>' +
        '</div>' +
        '<div style="max-height:60vh;overflow-y:auto;">' + listHtml + '</div>' +
        '<div style="padding:10px;text-align:center;background:#f5f5f5;font-size:0.85em;color:#666;">' +
        'Cliquez sur un article pour l\'utiliser' +
        '</div></div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.remove();
    });
}

function applyLocalSuggestion(articleId) {
    // Trouver l'article
    var art = null;
    for (var i = 0; i < FACT_ARTICLES.length; i++) {
        if (FACT_ARTICLES[i].id === articleId) {
            art = FACT_ARTICLES[i];
            break;
        }
    }
    if (!art) return;
    
    // Remplir les champs
    getEl('art_nom').value = art.nom;
    getEl('art_nom').classList.add('input-matched');
    getEl('art_id').value = art.id;
    getEl('art_code').value = art.code || '';
    
    // Cat√©gorie
    if (art.categorie_id) {
        for (var i = 0; i < FACT_CATEGORIES.length; i++) {
            if (String(FACT_CATEGORIES[i].id) === String(art.categorie_id)) {
                getEl('art_categorie').value = FACT_CATEGORIES[i].nom;
                getEl('art_categorie').classList.add('input-matched');
                getEl('art_categorie_id').value = FACT_CATEGORIES[i].id;
                getEl('art_categorie_nom').value = FACT_CATEGORIES[i].nom;
                break;
            }
        }
    }
    
    // Prix (conversion si USD)
    var appro = FACT_DERNIERS_APPROS[String(art.id)] || {};
    var deviseActuelle = getDevise();
    var taux = factGetTaux();
    
    function convertirPrix(prixFC) {
        if (deviseActuelle === 'USD' && taux > 0) {
            return Math.round((prixFC / taux) * 100) / 100;
        }
        return prixFC;
    }
    
    // Prix d'achat
    var prixAchat = appro.prix_achat_unitaire || art.prix_achat || 0;
    if (prixAchat > 0) getEl('art_prix_achat').value = convertirPrix(prixAchat);
    
    // Prix de vente (toujours en FC)
    if (art.prix_vente > 0) getEl('art_prix_vente').value = art.prix_vente;
    
    // Carton si disponible
    if (appro.type_quantite === 'CARTON') {
        if (appro.nombre_cartons > 0) getEl('art_nb_cartons').value = appro.nombre_cartons;
        if (appro.pieces_par_carton > 0) getEl('art_pcs_carton').value = appro.pieces_par_carton;
        if (appro.prix_achat_carton > 0) getEl('art_prix_carton').value = convertirPrix(appro.prix_achat_carton);
    }
    
    // Fermer modal et recalculer
    var modal = document.getElementById('suggestionModal');
    if (modal) modal.remove();
    
    updateModeIndicator();
    calculerSaisie();
    getEl('art_nb_cartons').focus();
}

</script>

<!-- Modal Modifier Nom Article -->
<div class="modal fade" id="modalModifierNom" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:16px;border:none;box-shadow:0 10px 40px rgba(0,0,0,.2);">
            <div class="modal-header" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:16px 16px 0 0;border:none;">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifier le nom</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body" style="padding:24px;">
                <input type="hidden" id="modalNomIndex">
                <div class="mb-3">
                    <label class="form-label fw-bold">Nom de l'article</label>
                    <input type="text" class="form-control form-control-lg" id="modalNomInput" 
                           placeholder="Saisissez le nouveau nom..." 
                           style="border-radius:10px;border:2px solid #e0e0e0;font-size:1.1rem;"
                           onkeydown="if(event.key==='Enter'){validerModifNom();}">
                </div>
                <div id="modalNomInfo" class="text-muted small">
                    <i class="fas fa-info-circle me-1"></i>Le nom sera mis √† jour dans la facture
                </div>
            </div>
            <div class="modal-footer" style="border:none;padding:16px 24px 24px;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius:8px;">
                    <i class="fas fa-times me-1"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary" onclick="validerModifNom()" style="border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;">
                    <i class="fas fa-check me-1"></i>Valider
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
