{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Saisie inventaire - {{ inventaire.reference }}{% endblock %}

{% block extra_css %}
<style>
/* === IA INVENTAIRE === */
.ia-box { position: relative; display: inline-block; }
.btn-ia-inv { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; font-size: .8rem; padding: 5px 12px; border-radius: 8px; cursor: pointer; transition: all .2s; }
.btn-ia-inv:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(102,126,234,.4); color: #fff; }
.ia-menu { position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,.15); z-index: 100; margin-top: 5px; min-width: 280px; display: none; }
.ia-menu.visible { display: block; }
.ia-menu-header { padding: 10px 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; font-size: .8rem; border-radius: 10px 10px 0 0; }
.ia-menu-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background .15s; }
.ia-menu-item:hover { background: #f5f7ff; }
.ia-menu-item:last-child { border-bottom: none; border-radius: 0 0 10px 10px; }
.ia-menu-item .ia-icon { color: #667eea; margin-right: 10px; width: 18px; text-align: center; }
.ia-menu-item .ia-title { font-weight: 600; font-size: .85rem; }
.ia-menu-item .ia-desc { font-size: .75rem; color: #6c757d; margin-top: 2px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-edit text-primary"></i> Saisie inventaire</h2>
            <p class="mb-0 text-muted">{{ inventaire.reference }} - {{ boutique.nom }}</p>
        </div>
        <div>
            <span class="badge bg-success me-2">{{ nb_saisis }} saisis</span>
            <span class="badge bg-warning text-dark">{{ nb_non_saisis }} restants</span>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body py-2">
            <form method="get" class="row g-2 align-items-center">
                <div class="col-auto">
                    <div class="btn-group" role="group">
                        <a href="?filtre=non_saisis" class="btn btn-sm {% if filtre == 'non_saisis' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Non saisis ({{ nb_non_saisis }})
                        </a>
                        <a href="?filtre=saisis" class="btn btn-sm {% if filtre == 'saisis' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Saisis ({{ nb_saisis }})
                        </a>
                        <a href="?filtre=ecarts" class="btn btn-sm {% if filtre == 'ecarts' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                            √âcarts
                        </a>
                        <a href="?filtre=tous" class="btn btn-sm {% if filtre == 'tous' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                            Tous
                        </a>
                    </div>
                </div>
                <div class="col-auto">
                    <select name="categorie" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">Toutes cat√©gories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if categorie_id == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <input type="text" name="q" id="searchInventaire" class="form-control form-control-sm" placeholder="Rechercher un article..." value="{{ recherche }}" autocomplete="off">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-outline-primary"><i class="fas fa-search"></i></button>
                </div>
                <div class="col-auto" id="searchCount" style="display:none;">
                    <span class="badge bg-info" id="searchCountBadge">0 trouv√©(s)</span>
                </div>
                <div class="col-auto ia-box">
                    <button type="button" class="btn-ia-inv" onclick="toggleIaMenu()">
                        <i class="fas fa-magic me-1"></i>IA
                    </button>
                    <div class="ia-menu" id="iaMenu">
                        <div class="ia-menu-header"><i class="fas fa-robot me-1"></i> Assistant inventaire</div>
                        <div class="ia-menu-item" onclick="iaAction('copier_stock')">
                            <span class="ia-icon"><i class="fas fa-copy"></i></span>
                            <span class="ia-title">Copier stock syst√®me</span>
                            <div class="ia-desc">Remplir tous les champs vides avec le stock th√©orique (0 √©cart)</div>
                        </div>
                        <div class="ia-menu-item" onclick="iaAction('vider_tout')">
                            <span class="ia-icon"><i class="fas fa-eraser"></i></span>
                            <span class="ia-title">Vider les saisies</span>
                            <div class="ia-desc">Effacer toutes les valeurs saisies</div>
                        </div>
                        <div class="ia-menu-item" onclick="iaAction('focus_vides')">
                            <span class="ia-icon"><i class="fas fa-search"></i></span>
                            <span class="ia-title">Aller au premier vide</span>
                            <div class="ia-desc">Positionner le curseur sur le premier article non saisi</div>
                        </div>
                        <div class="ia-menu-item" onclick="iaAction('stats')">
                            <span class="ia-icon"><i class="fas fa-chart-bar"></i></span>
                            <span class="ia-title">R√©sum√© rapide</span>
                            <div class="ia-desc">Voir les statistiques de l'inventaire en cours</div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%">Article</th>
                                <th class="text-center" style="width: 15%">Stock syst√®me</th>
                                <th class="text-center" style="width: 20%">Stock physique</th>
                                <th class="text-center" style="width: 10%">√âcart</th>
                                <th style="width: 25%">Commentaire</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ligne in lignes %}
                            <tr class="{% if ligne.ecart > 0 %}table-success{% elif ligne.ecart < 0 %}table-danger{% endif %}" data-search="{{ ligne.article.nom|lower }} {{ ligne.article.code|lower }}">
                                <td>
                                    <strong>{{ ligne.article.nom }}</strong>
                                    <br><small class="text-muted">{{ ligne.article.code }}</small>
                                </td>
                                <td class="text-center align-middle">
                                    <span class="badge bg-secondary fs-6">{{ ligne.stock_theorique }}</span>
                                </td>
                                <td class="text-center">
                                    <input type="number" name="stock_physique_{{ ligne.id }}" 
                                           class="form-control form-control-lg text-center stock-input"
                                           value="{% if ligne.stock_physique is not None %}{{ ligne.stock_physique }}{% endif %}"
                                           min="0" placeholder="?" data-theorique="{{ ligne.stock_theorique }}"
                                           data-ligne-id="{{ ligne.id }}">
                                </td>
                                <td class="text-center align-middle">
                                    <span class="ecart-display" id="ecart_{{ ligne.id }}">
                                        {% if ligne.ecart > 0 %}<span class="badge bg-success">+{{ ligne.ecart }}</span>
                                        {% elif ligne.ecart < 0 %}<span class="badge bg-danger">{{ ligne.ecart }}</span>
                                        {% elif ligne.stock_physique is not None %}<span class="badge bg-secondary">0</span>{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <input type="text" name="commentaire_{{ ligne.id }}" 
                                           class="form-control form-control-sm"
                                           value="{{ ligne.commentaire }}" placeholder="Justification...">
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    {% if filtre == 'non_saisis' %}Tous les articles ont √©t√© saisis !{% else %}Aucun article trouv√©{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% if lignes %}
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <a href="{% url 'inventory:detail_inventaire_boutique' boutique.id inventaire.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Retour
                    </a>
                    <div>
                        <button type="submit" name="continuer" class="btn btn-outline-primary me-2">
                            <i class="fas fa-save"></i> Enregistrer et continuer
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Enregistrer
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </form>

    {% if total_lignes > 50 %}
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle"></i> Affichage limit√© √† 50 articles. Utilisez les filtres.
    </div>
    {% endif %}
</div>

<script>
// =============================================
// IA INVENTAIRE - FONCTIONS
// =============================================
function toggleIaMenu() {
    document.getElementById('iaMenu').classList.toggle('visible');
}

function iaAction(action) {
    const inputs = document.querySelectorAll('.stock-input');
    toggleIaMenu();
    
    if (action === 'copier_stock') {
        let count = 0;
        inputs.forEach(input => {
            if (input.value === '' || input.value === null) {
                input.value = input.dataset.theorique;
                input.dispatchEvent(new Event('input'));
                count++;
            }
        });
        alert('‚úÖ ' + count + ' champ(s) rempli(s) avec le stock syst√®me');
    }
    else if (action === 'vider_tout') {
        if (!confirm('Effacer toutes les saisies de stock physique ?')) return;
        inputs.forEach(input => {
            input.value = '';
            input.dispatchEvent(new Event('input'));
        });
    }
    else if (action === 'focus_vides') {
        for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].value === '' || inputs[i].value === null) {
                inputs[i].focus();
                inputs[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
        }
        alert('‚úÖ Tous les articles ont √©t√© saisis !');
    }
    else if (action === 'stats') {
        let saisis = 0, vides = 0, ecartPos = 0, ecartNeg = 0, ecartZero = 0;
        inputs.forEach(input => {
            if (input.value !== '' && input.value !== null) {
                saisis++;
                const theorique = parseInt(input.dataset.theorique) || 0;
                const physique = parseInt(input.value) || 0;
                const ecart = physique - theorique;
                if (ecart > 0) ecartPos++;
                else if (ecart < 0) ecartNeg++;
                else ecartZero++;
            } else {
                vides++;
            }
        });
        alert('üìä R√âSUM√â INVENTAIRE\n\n' +
              'üìù Saisis: ' + saisis + '\n' +
              '‚è≥ Restants: ' + vides + '\n' +
              '‚úÖ Sans √©cart: ' + ecartZero + '\n' +
              'üìà √âcarts positifs: ' + ecartPos + '\n' +
              'üìâ √âcarts n√©gatifs: ' + ecartNeg);
    }
}

// Fermer menu si clic ailleurs
document.addEventListener('click', function(e) {
    if (!e.target.closest('.ia-box')) {
        document.getElementById('iaMenu').classList.remove('visible');
    }
});

// Calcul √©cart en temps r√©el
document.querySelectorAll('.stock-input').forEach(input => {
    input.addEventListener('input', function() {
        const theorique = parseInt(this.dataset.theorique) || 0;
        const physique = parseInt(this.value);
        const ligneId = this.dataset.ligneId;
        const ecartEl = document.getElementById('ecart_' + ligneId);
        
        if (!isNaN(physique)) {
            const ecart = physique - theorique;
            if (ecart > 0) {
                ecartEl.innerHTML = '<span class="badge bg-success">+' + ecart + '</span>';
                this.closest('tr').className = 'table-success';
            } else if (ecart < 0) {
                ecartEl.innerHTML = '<span class="badge bg-danger">' + ecart + '</span>';
                this.closest('tr').className = 'table-danger';
            } else {
                ecartEl.innerHTML = '<span class="badge bg-secondary">0</span>';
                this.closest('tr').className = '';
            }
        } else {
            ecartEl.innerHTML = '';
            this.closest('tr').className = '';
        }
    });
});

// Recherche instantan√©e c√¥t√© client
(function() {
    var searchInput = document.getElementById('searchInventaire');
    if (!searchInput) return;
    var rows = document.querySelectorAll('tbody tr[data-search]');
    var countEl = document.getElementById('searchCount');
    var countBadge = document.getElementById('searchCountBadge');
    var debounce = null;

    searchInput.addEventListener('input', function() {
        clearTimeout(debounce);
        debounce = setTimeout(function() {
            var q = searchInput.value.trim().toLowerCase();
            var visible = 0;
            for (var i = 0; i < rows.length; i++) {
                var data = rows[i].getAttribute('data-search') || '';
                if (!q || data.indexOf(q) >= 0) {
                    rows[i].style.display = '';
                    visible++;
                } else {
                    rows[i].style.display = 'none';
                }
            }
            if (q) {
                countBadge.textContent = visible + ' trouv√©(s)';
                countEl.style.display = '';
            } else {
                countEl.style.display = 'none';
            }
        }, 150);
    });

    // Focus auto sur le champ recherche
    searchInput.focus();
})();
</script>
{% endblock %}
