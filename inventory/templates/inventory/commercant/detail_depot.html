{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Dépôt {{ depot.nom }} - {{ depot.commercant.nom_entreprise }}{% endblock %}

{% block extra_css %}
<style>
    .depot-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #f5576c;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    .article-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .article-row:hover {
        background-color: #f8f9fa;
    }
    .stock-badge {
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    .stock-ok {
        background-color: #d4edda;
        color: #155724;
    }
    .stock-bas {
        background-color: #fff3cd;
        color: #856404;
    }
    .stock-zero {
        background-color: #f8d7da;
        color: #721c24;
    }
    .transfert-item {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #f5576c;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .badge-en-attente {
        background-color: #ffc107;
        color: #000;
    }
    .badge-valide {
        background-color: #28a745;
        color: #fff;
    }
    .badge-annule {
        background-color: #6c757d;
        color: #fff;
    }

    .depot-sidebar {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 2rem);
        display: flex;
        flex-direction: column;
    }
    .depot-sidebar-header {
        background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
        color: #fff;
        padding: 12px 14px;
        font-weight: 700;
    }
    .depot-sidebar-body {
        overflow-y: auto;
    }
    .depot-sidebar .list-group-item {
        border: 0;
        border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .depot-sidebar .list-group-item:last-child {
        border-bottom: 0;
    }
    .depot-sidebar .pdv-name {
        font-weight: 600;
    }
    .depot-sidebar .pdv-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .depot-sidebar-toggle {
        border-radius: 10px;
    }

    .depot-articles-table {
        font-size: 0.9rem;
    }
    .depot-articles-table th,
    .depot-articles-table td {
        vertical-align: middle;
    }

    .article-actions {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        justify-content: center;
    }
    .article-actions .btn {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
        line-height: 1.1;
    }

    .depot-sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        z-index: 1040;
    }

    @media (max-width: 991.98px) {
        .depot-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            max-height: 100vh;
            border-radius: 0;
            z-index: 1050;
            transform: translateX(-110%);
            transition: transform 0.25s ease;
        }
        .depot-sidebar.show {
            transform: translateX(0);
        }
        .depot-sidebar-overlay.show {
            display: block;
        }
    }
    
    /* Responsive Mobile */
    @media (max-width: 576px) {
        .depot-header {
            padding: 15px;
            border-radius: 10px;
        }
        .depot-header h2 {
            font-size: 1.2rem;
        }
        .depot-header p, .depot-header small {
            font-size: 0.8rem;
        }
        .depot-header .btn-sm {
            font-size: 0.7rem;
            padding: 4px 8px;
            margin-bottom: 5px;
        }
        .depot-header .col-md-4 {
            text-align: center !important;
            margin-top: 10px;
        }
        .stat-card {
            padding: 12px;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 1.3rem;
        }
        .stat-label {
            font-size: 0.75rem;
        }
        .table {
            font-size: 0.8rem;
        }
        .table th, .table td {
            padding: 8px 5px;
        }
        .stock-badge {
            font-size: 0.7rem;
            padding: 3px 6px;
        }
        .transfert-item {
            padding: 10px;
        }
        .transfert-item .text-muted {
            font-size: 0.75rem;
        }
        .card-header h5 {
            font-size: 0.95rem;
        }
        .modal-dialog {
            margin: 10px;
        }
        .modal-body {
            padding: 15px;
        }
        .form-label {
            font-size: 0.85rem;
        }
        .form-control, .form-select {
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="depot-sidebar-overlay" id="depotSidebarOverlay" onclick="toggleDepotSidebar()"></div>

    <div class="row g-3">
        <div class="col-lg-3">
            <button class="btn btn-dark btn-sm w-100 d-lg-none depot-sidebar-toggle" type="button" onclick="toggleDepotSidebar()">
                <i class="fas fa-store me-2"></i>Points de vente
            </button>

            <div class="depot-sidebar" id="depotSidebar">
                <div class="depot-sidebar-header">
                    <i class="fas fa-store me-2"></i>Points de vente
                </div>
                <div class="depot-sidebar-body">
                    <div class="list-group list-group-flush">
                        {% for boutique in boutiques_destination %}
                        <a href="{% url 'inventory:entrer_boutique' boutique.id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="pdv-name">{{ boutique.nom }}</div>
                                    <div class="pdv-meta">{% if boutique.ville %}{{ boutique.ville }}{% endif %}</div>
                                </div>
                                <span class="badge bg-secondary">{{ boutique.articles.count }}</span>
                            </div>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-muted text-center py-3">Aucun point de vente</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
    <!-- En-tête du dépôt -->
    <div class="depot-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-warehouse me-2"></i>{{ depot.nom }}</h2>
                <p class="mb-0 opacity-75">{{ depot.commercant.nom_entreprise }}</p>
                <small class="opacity-75">{{ depot.adresse }}{% if depot.ville %}, {{ depot.ville }}{% endif %}</small>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'inventory:commercant_liste_depots' %}" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
                <a href="{% url 'inventory:historique_transferts' depot.id %}" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-history"></i> Historique
                </a>
                <a href="{% url 'inventory:transfert_multiple' depot.id %}" class="btn btn-warning btn-sm me-2">
                    <i class="fas fa-exchange-alt"></i> Transfert Multiple
                </a>
                <a href="{% url 'inventory:importer_articles_vers_depot' depot.id %}" class="btn btn-info btn-sm me-2" title="Importer des articles depuis vos points de vente">
                    <i class="fas fa-file-import"></i> Importer Articles
                </a>
                <a href="{% url 'inventory:importer_excel_depot' depot.id %}" class="btn btn-success btn-sm me-2" title="Importer des articles depuis un fichier Excel">
                    <i class="fas fa-file-excel"></i> Import Excel
                </a>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#approvisionnementModal" title="Approvisionner le dépôt">
                    <i class="fas fa-plus-circle"></i> Approvisionner
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-value">{{ total_articles }}</div>
                <div class="stat-label">ARTICLES EN STOCK</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-value">{{ valeur_stock|floatformat:0 }} CDF</div>
                <div class="stat-label">VALEUR DU STOCK</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-value">{{ articles_stock_bas }}</div>
                <div class="stat-label">ARTICLES EN STOCK BAS</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Liste des articles -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes"></i> Articles du dépôt</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-12 col-md-6 col-lg-5">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchArticle" placeholder="Rechercher (nom ou code)" autofocus>
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">X</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm depot-articles-table" id="articlesTable">
                            <thead>
                                <tr>
                                    <th>Article</th>
                                    <th>Code</th>
                                    <th class="text-center">Stock</th>
                                    <th class="text-end">Achat</th>
                                    <th class="text-end">Vente</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for article in articles %}
                                <tr class="article-row" data-article-id="{{ article.id }}">
                                    <td>
                                        <strong>{{ article.nom }}</strong>
                                        {% if article.categorie %}
                                        <br><small class="text-muted">{{ article.categorie.nom }}</small>
                                        {% endif %}
                                    </td>
                                    <td><code>{{ article.code }}</code></td>
                                    <td class="text-center">
                                        {% if article.quantite_stock == 0 %}
                                        <span class="stock-badge stock-zero">{{ article.quantite_stock }}</span>
                                        {% elif article.quantite_stock <= depot.alerte_stock_bas %}
                                        <span class="stock-badge stock-bas">{{ article.quantite_stock }}</span>
                                        {% else %}
                                        <span class="stock-badge stock-ok">{{ article.quantite_stock }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ article.prix_achat|floatformat:0 }} CDF</td>
                                    <td class="text-end">{{ article.prix_vente|floatformat:0 }} CDF</td>
                                    <td class="text-center">
                                        <div class="article-actions">
                                            <button type="button" class="btn btn-success" title="Ajouter stock" aria-label="Ajouter stock"
                                                    onclick="openApprovisionnementForArticle({{ article.id }})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <a href="{% url 'inventory:modifier_article_depot' depot.id article.id %}" class="btn btn-warning" title="Modifier" aria-label="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'inventory:supprimer_article_depot' depot.id article.id %}" class="btn btn-danger" title="Supprimer" aria-label="Supprimer"
                                               onclick="return confirm('Supprimer cet article du dépôt ?');">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                            <button type="button" class="btn btn-primary" title="Transférer" aria-label="Transférer"
                                                    onclick="openTransfertModal({{ article.id }}, '{{ article.nom|escapejs }}', {{ article.quantite_stock }})">
                                                <i class="fas fa-exchange-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        Aucun article dans ce dépôt
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div id="noResultsMsg" class="alert alert-info d-none">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucun article trouvé.
                            <button type="button" class="btn btn-sm btn-success ms-3" data-bs-toggle="modal" data-bs-target="#approvisionnementModal">
                                <i class="fas fa-plus"></i> Ajouter un article
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
</div>

<!-- Modal de transfert -->
<div class="modal fade" id="transfertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'inventory:creer_transfert_stock' depot.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> Transférer un article</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="article_id" id="article_id">
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Article:</strong></label>
                        <p id="article_nom" class="form-control-plaintext"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Stock disponible:</strong></label>
                        <p id="article_stock" class="form-control-plaintext text-primary"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="boutique_destination" class="form-label">Point de vente de destination *</label>
                        <select class="form-select" name="boutique_destination" id="boutique_destination" required>
                            <option value="">-- Sélectionner un point de vente --</option>
                            {% for boutique in boutiques_destination %}
                            <option value="{{ boutique.id }}">{{ boutique.nom }} - {{ boutique.ville }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quantite" class="form-label">Quantité à transférer *</label>
                        <input type="number" class="form-control" name="quantite" id="quantite" 
                               min="1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="commentaire" class="form-label">Commentaire (optionnel)</label>
                        <textarea class="form-control" name="commentaire" id="commentaire" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Créer le transfert
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'approvisionnement -->
<div class="modal fade" id="approvisionnementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'inventory:approvisionner_depot' depot.id %}" id="approForm">
                {% csrf_token %}
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Approvisionner le dépôt</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="approTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="nouveau-tab" data-bs-toggle="tab" data-bs-target="#nouveau" type="button">
                                <i class="fas fa-plus"></i> Nouvel article
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="existant-tab" data-bs-toggle="tab" data-bs-target="#existant" type="button">
                                <i class="fas fa-box"></i> Article existant
                            </button>
                        </li>
                    </ul>
                    
                    <input type="hidden" name="type_appro" id="type_appro" value="nouveau">
                    
                    <div class="tab-content" id="approTabContent">
                        <!-- Nouvel article -->
                        <div class="tab-pane fade show active" id="nouveau" role="tabpanel">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="code" class="form-label">Code article <small class="text-muted">(optionnel - généré auto si vide)</small></label>
                                    <input type="text" class="form-control" name="code" id="code" placeholder="Laissez vide pour générer automatiquement">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="nom" class="form-label">Nom de l'article *</label>
                                    <input type="text" class="form-control" name="nom" id="nom">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="prix_achat" class="form-label">Prix d'achat (CDF) *</label>
                                    <input type="number" class="form-control" name="prix_achat" id="prix_achat" min="0" step="0.01">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="prix_vente" class="form-label">Prix de vente (CDF) *</label>
                                    <input type="number" class="form-control" name="prix_vente" id="prix_vente" min="0" step="0.01">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="quantite_initiale" class="form-label">Quantité *</label>
                                    <input type="number" class="form-control" name="quantite_initiale" id="quantite_initiale" min="1" value="1">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">Description (optionnel)</label>
                                <textarea class="form-control" name="description" id="description" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <!-- Article existant -->
                        <div class="tab-pane fade" id="existant" role="tabpanel">
                            <div class="mb-3">
                                <label for="article_existant" class="form-label">Sélectionner un article *</label>
                                <select class="form-select" name="article_existant" id="article_existant">
                                    <option value="">-- Choisir un article --</option>
                                    {% for article in articles %}
                                    <option value="{{ article.id }}">{{ article.nom }} ({{ article.code }}) - Stock: {{ article.quantite_stock }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="quantite_ajout" class="form-label">Quantité à ajouter *</label>
                                <input type="number" class="form-control" name="quantite_ajout" id="quantite_ajout" min="1" value="1">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Approvisionner
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleDepotSidebar() {
    var sidebar = document.getElementById('depotSidebar');
    var overlay = document.getElementById('depotSidebarOverlay');
    if (!sidebar || !overlay) {
        return;
    }
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

window.addEventListener('resize', function() {
    if (window.innerWidth >= 992) {
        var sidebar = document.getElementById('depotSidebar');
        var overlay = document.getElementById('depotSidebarOverlay');
        if (sidebar) sidebar.classList.remove('show');
        if (overlay) overlay.classList.remove('show');
    }
});

function openTransfertModal(articleId, articleNom, articleStock) {
    document.getElementById('article_id').value = articleId;
    document.getElementById('article_nom').textContent = articleNom;
    document.getElementById('article_stock').textContent = articleStock + ' unités';
    document.getElementById('quantite').max = articleStock;
    
    var modal = new bootstrap.Modal(document.getElementById('transfertModal'));
    modal.show();
}

function filterDepotArticles() {
    var q = (document.getElementById('searchArticle')?.value || '').toLowerCase();
    var rows = document.querySelectorAll('#articlesTable tbody tr.article-row');
    var visibleCount = 0;
    rows.forEach(function(row) {
        var name = (row.querySelector('td strong')?.textContent || '').toLowerCase();
        var code = (row.querySelector('td code')?.textContent || '').toLowerCase();
        var show = !q || name.includes(q) || code.includes(q);
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    var noResultsMsg = document.getElementById('noResultsMsg');
    if (noResultsMsg) {
        if (visibleCount === 0 && q && rows.length > 0) {
            noResultsMsg.classList.remove('d-none');
        } else {
            noResultsMsg.classList.add('d-none');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('searchArticle');
    var clear = document.getElementById('clearSearch');
    if (input) {
        input.addEventListener('input', filterDepotArticles);
    }
    if (clear && input) {
        clear.addEventListener('click', function() {
            input.value = '';
            filterDepotArticles();
            input.focus();
        });
    }
});

var approTargetArticleId = null;

function openApprovisionnementForArticle(articleId) {
    approTargetArticleId = articleId;
    var modalEl = document.getElementById('approvisionnementModal');
    if (!modalEl) {
        return;
    }
    var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

document.addEventListener('DOMContentLoaded', function() {
    var modalEl = document.getElementById('approvisionnementModal');
    if (!modalEl) {
        return;
    }

    modalEl.addEventListener('shown.bs.modal', function() {
        if (!approTargetArticleId) {
            return;
        }

        var existTabBtn = document.getElementById('existant-tab');
        if (existTabBtn) {
            var tab = new bootstrap.Tab(existTabBtn);
            tab.show();
        }

        var select = document.getElementById('article_existant');
        if (select) {
            select.value = String(approTargetArticleId);
        }

        var qty = document.getElementById('quantite_ajout');
        if (qty && !qty.value) {
            qty.value = 1;
        }

        approTargetArticleId = null;
    });
});

// Gérer le changement d'onglet pour le type d'approvisionnement
document.querySelectorAll('#approTab button').forEach(function(tab) {
    tab.addEventListener('shown.bs.tab', function() {
        var target = this.getAttribute('data-bs-target');
        document.getElementById('type_appro').value = (target === '#nouveau') ? 'nouveau' : 'existant';
        console.log('Type appro changé:', document.getElementById('type_appro').value);
    });
});
</script>
{% endblock %}
