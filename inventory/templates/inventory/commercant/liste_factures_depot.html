{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Factures d'approvisionnement - {{ depot.nom }}{% endblock %}

{% block extra_css %}
<style>
.factures-header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:18px; }
.factures-header h2 { margin:0; font-size:1.35rem; }
.factures-header .sub { color:#6c757d; font-size:.82rem; }
.stats-bar { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
.stat-card { background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:10px 16px; min-width:140px; flex:1; }
.stat-card .stat-label { font-size:.7rem; color:#6c757d; text-transform:uppercase; letter-spacing:.5px; }
.stat-card .stat-value { font-size:1.25rem; font-weight:700; color:#212529; }
.stat-card .stat-value small { font-size:.7rem; font-weight:400; color:#6c757d; }
.search-bar { background:#fff; border:1px solid #e9ecef; border-radius:10px; padding:14px 18px; margin-bottom:16px; }
.search-bar .search-row { display:flex; gap:10px; align-items:end; flex-wrap:wrap; }
.search-bar .search-main { flex:2; min-width:200px; }
.search-bar .search-filter { flex:1; min-width:120px; }
.search-bar label { font-size:.7rem; color:#6c757d; text-transform:uppercase; letter-spacing:.5px; margin-bottom:2px; display:block; }
.search-bar input, .search-bar select { font-size:.85rem; }
.search-bar .btn-search { height:38px; }
.results-info { font-size:.78rem; color:#6c757d; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.results-info strong { color:#212529; }
.table-factures { width:100%; border-collapse:separate; border-spacing:0; }
.table-factures thead th { background:#f8f9fa; font-size:.72rem; text-transform:uppercase; letter-spacing:.5px; color:#6c757d; padding:8px 12px; border-bottom:2px solid #dee2e6; position:sticky; top:0; white-space:nowrap; z-index:2; }
.table-factures thead th a { color:#6c757d; text-decoration:none; }
.table-factures thead th a:hover { color:#0d6efd; }
.table-factures thead th .sort-icon { font-size:.6rem; margin-left:3px; }
.table-factures tbody tr { transition: background .15s; cursor:pointer; }
.table-factures tbody tr:hover { background:#f0f4ff; }
.table-factures tbody td { padding:10px 12px; border-bottom:1px solid #f0f0f0; font-size:.85rem; vertical-align:middle; }
.table-factures .num-facture { font-weight:600; color:#0d6efd; }
.table-factures .fournisseur { max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.table-factures .montant { font-weight:600; white-space:nowrap; }
.table-factures .montant.cdf { color:#198754; }
.table-factures .montant.usd { color:#0d6efd; }
.badge-articles { background:#e8f0fe; color:#1a73e8; font-weight:600; padding:3px 8px; border-radius:12px; font-size:.75rem; }
.articles-list { font-size:.7rem; color:#6c757d; max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.btn-voir { font-size:.75rem; padding:3px 10px; }
.pagination-bar { display:flex; align-items:center; justify-content:space-between; margin-top:12px; font-size:.8rem; }
.pagination-bar .page-info { color:#6c757d; }
.pagination-bar .pagination { margin:0; }
.pagination-bar .page-link { font-size:.8rem; padding:4px 10px; }
.empty-state { text-align:center; padding:50px 20px; color:#adb5bd; }
.empty-state i { font-size:3rem; margin-bottom:12px; }
.highlight { background:#fff3cd; padding:1px 2px; border-radius:2px; }
/* === RECHERCHE IA === */
.ia-search-box { position:relative; }
.btn-ia { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none; font-size:.75rem; padding:4px 10px; border-radius:6px; cursor:pointer; transition:all .2s; }
.btn-ia:hover { transform:scale(1.05); box-shadow:0 2px 8px rgba(102,126,234,.4); }
.btn-ia i { margin-right:4px; }
.ia-suggestions { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #e0e0e0; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); z-index:100; margin-top:4px; display:none; }
.ia-suggestions.visible { display:block; }
.ia-suggestions .ia-header { padding:8px 12px; background:#f8f9fa; border-bottom:1px solid #eee; font-size:.7rem; color:#6c757d; }
.ia-suggestion { padding:10px 14px; cursor:pointer; border-bottom:1px solid #f0f0f0; transition:background .15s; }
.ia-suggestion:hover { background:#f0f4ff; }
.ia-suggestion:last-child { border-bottom:none; }
.ia-suggestion .ia-icon { color:#667eea; margin-right:8px; }
.ia-suggestion .ia-text { font-size:.85rem; }
.ia-suggestion .ia-desc { font-size:.7rem; color:#6c757d; margin-top:2px; }
@media(max-width:768px) {
    .search-bar .search-row { flex-direction:column; }
    .stats-bar { flex-direction:column; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header -->
    <div class="factures-header">
        <div>
            <h2><i class="fas fa-file-invoice me-2"></i>Factures d'approvisionnement</h2>
            <span class="sub">{{ depot.nom }} &mdash; {{ total_count }} facture{{ total_count|pluralize }}</span>
        </div>
        <div style="display:flex;gap:8px;">
            <a href="{% url 'inventory:approvisionner_facture' depot.id %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>Nouvelle facture
            </a>
            <a href="{% url 'inventory:detail_depot' depot.id %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Retour
            </a>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-label">Total factures</div>
            <div class="stat-value">{{ stats.nb_factures|default:0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Montant CDF</div>
            <div class="stat-value" style="color:#198754;">{{ stats.total_montant_cdf|floatformat:0|default:"0" }} <small>FC</small></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Montant USD</div>
            <div class="stat-value" style="color:#0d6efd;">{{ stats.total_montant_usd|floatformat:0|default:"0" }} <small>$</small></div>
        </div>
    </div>

    <!-- Barre de recherche -->
    <div class="search-bar">
        <form method="get" id="searchForm">
            <div class="search-row">
                <div class="search-main ia-search-box">
                    <label for="q"><i class="fas fa-search me-1"></i>Recherche</label>
                    <div style="display:flex;gap:6px;">
                        <input type="text" class="form-control form-control-sm" id="q" name="q" value="{{ q }}"
                               placeholder="N° facture, fournisseur, article... ou question IA"
                               oninput="clearTimeout(window._st); window._st=setTimeout(function(){document.getElementById('searchForm').submit()},600);"
                               onfocus="showIaSuggestions()" onblur="setTimeout(hideIaSuggestions,200)">
                        <button type="button" class="btn-ia" onclick="toggleIaSuggestions()" title="Recherche intelligente">
                            <i class="fas fa-magic"></i>IA
                        </button>
                    </div>
                    <div class="ia-suggestions" id="iaSuggestions">
                        <div class="ia-header"><i class="fas fa-lightbulb me-1"></i>Suggestions de recherche intelligente</div>
                        <div class="ia-suggestion" onclick="applyIaSearch('ce mois')">
                            <span class="ia-icon"><i class="fas fa-calendar-alt"></i></span>
                            <span class="ia-text">Factures de ce mois</span>
                            <div class="ia-desc">Afficher toutes les factures du mois en cours</div>
                        </div>
                        <div class="ia-suggestion" onclick="applyIaSearch('mois dernier')">
                            <span class="ia-icon"><i class="fas fa-history"></i></span>
                            <span class="ia-text">Factures du mois dernier</span>
                            <div class="ia-desc">Afficher les factures du mois précédent</div>
                        </div>
                        <div class="ia-suggestion" onclick="applyIaSearch('cette semaine')">
                            <span class="ia-icon"><i class="fas fa-calendar-week"></i></span>
                            <span class="ia-text">Factures de cette semaine</span>
                            <div class="ia-desc">Afficher les factures des 7 derniers jours</div>
                        </div>
                        <div class="ia-suggestion" onclick="applyIaSearch('gros montant')">
                            <span class="ia-icon"><i class="fas fa-dollar-sign"></i></span>
                            <span class="ia-text">Factures à gros montant</span>
                            <div class="ia-desc">Trier par montant décroissant</div>
                        </div>
                        <div class="ia-suggestion" onclick="applyIaSearch('recentes')">
                            <span class="ia-icon"><i class="fas fa-clock"></i></span>
                            <span class="ia-text">Factures les plus récentes</span>
                            <div class="ia-desc">Trier par date décroissante</div>
                        </div>
                    </div>
                </div>
                <div class="search-filter">
                    <label for="devise">Devise</label>
                    <select class="form-select form-select-sm" id="devise" name="devise" onchange="this.form.submit()">
                        <option value="">Toutes</option>
                        <option value="CDF" {% if devise_filter == 'CDF' %}selected{% endif %}>CDF</option>
                        <option value="USD" {% if devise_filter == 'USD' %}selected{% endif %}>USD</option>
                    </select>
                </div>
                <div class="search-filter">
                    <label for="date_debut">Du</label>
                    <input type="date" class="form-control form-control-sm" id="date_debut" name="date_debut" value="{{ date_debut }}" onchange="this.form.submit()">
                </div>
                <div class="search-filter">
                    <label for="date_fin">Au</label>
                    <input type="date" class="form-control form-control-sm" id="date_fin" name="date_fin" value="{{ date_fin }}" onchange="this.form.submit()">
                </div>
                <div>
                    <label>&nbsp;</label>
                    {% if q or devise_filter or date_debut or date_fin %}
                    <a href="{% url 'inventory:liste_factures_depot' depot.id %}" class="btn btn-outline-secondary btn-sm btn-search" title="Effacer filtres">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
            <input type="hidden" name="tri" value="{{ tri }}">
        </form>
    </div>

    <!-- Info résultats -->
    {% if q or devise_filter or date_debut or date_fin %}
    <div class="results-info">
        <i class="fas fa-filter"></i>
        <strong>{{ filtered_count }}</strong> résultat{{ filtered_count|pluralize }} sur {{ total_count }}
        {% if q %}&mdash; recherche: <em>"{{ q }}"</em>{% endif %}
        {% if devise_filter %}&mdash; devise: <strong>{{ devise_filter }}</strong>{% endif %}
        {% if date_debut %}&mdash; du <strong>{{ date_debut }}</strong>{% endif %}
        {% if date_fin %}&mdash; au <strong>{{ date_fin }}</strong>{% endif %}
    </div>
    {% endif %}

    <!-- Tableau -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height:calc(100vh - 340px);overflow-y:auto;">
                <table class="table-factures">
                    <thead>
                        <tr>
                            <th>
                                <a href="?q={{ q }}&devise={{ devise_filter }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&tri={% if tri == 'numero_facture' %}-numero_facture{% else %}numero_facture{% endif %}">
                                    N° Facture {% if tri == 'numero_facture' %}<i class="fas fa-sort-up sort-icon"></i>{% elif tri == '-numero_facture' %}<i class="fas fa-sort-down sort-icon"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?q={{ q }}&devise={{ devise_filter }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&tri={% if tri == '-date_facture' %}date_facture{% else %}-date_facture{% endif %}">
                                    Date {% if tri == '-date_facture' %}<i class="fas fa-sort-down sort-icon"></i>{% elif tri == 'date_facture' %}<i class="fas fa-sort-up sort-icon"></i>{% endif %}
                                </a>
                            </th>
                            <th>Fournisseur</th>
                            <th>Articles</th>
                            <th class="text-end">
                                <a href="?q={{ q }}&devise={{ devise_filter }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&tri={% if tri == '-montant_total' %}montant_total{% else %}-montant_total{% endif %}">
                                    Montant {% if tri == '-montant_total' %}<i class="fas fa-sort-down sort-icon"></i>{% elif tri == 'montant_total' %}<i class="fas fa-sort-up sort-icon"></i>{% endif %}
                                </a>
                            </th>
                            <th class="text-center" style="width:80px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for facture in factures %}
                        <tr onclick="window.location='{% url 'inventory:detail_facture_depot' depot.id facture.id %}'" style="cursor:pointer;">
                            <td class="num-facture">{{ facture.numero_facture }}</td>
                            <td>{{ facture.date_facture|date:"d/m/Y" }}</td>
                            <td class="fournisseur">
                                {% if facture.fournisseur %}
                                    {{ facture.fournisseur.nom }}
                                {% else %}
                                    {{ facture.fournisseur_nom|default:"-" }}
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge-articles">{{ facture.lignes.all|length }}</span>
                                <span class="articles-list">
                                    {% for ligne in facture.lignes.all %}{% if forloop.counter <= 3 %}{% if not forloop.first %}, {% endif %}{{ ligne.article.nom }}{% endif %}{% endfor %}{% if facture.lignes.all|length > 3 %} +{{ facture.lignes.all|length|add:"-3" }}{% endif %}
                                </span>
                            </td>
                            <td class="text-end montant {% if facture.devise == 'CDF' %}cdf{% else %}usd{% endif %}">
                                {{ facture.montant_total|floatformat:0 }} {{ facture.devise }}
                            </td>
                            <td class="text-center" onclick="event.stopPropagation();">
                                <a href="{% url 'inventory:detail_facture_depot' depot.id facture.id %}" class="btn btn-sm btn-outline-primary btn-voir">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    {% if q or devise_filter or date_debut or date_fin %}
                                        <i class="fas fa-search d-block"></i>
                                        <p>Aucune facture ne correspond à votre recherche</p>
                                        <a href="{% url 'inventory:liste_factures_depot' depot.id %}" class="btn btn-outline-primary btn-sm">Effacer les filtres</a>
                                    {% else %}
                                        <i class="fas fa-inbox d-block"></i>
                                        <p>Aucune facture enregistrée</p>
                                        <a href="{% url 'inventory:approvisionner_facture' depot.id %}" class="btn btn-primary btn-sm">Créer une facture</a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="pagination-bar">
        <span class="page-info">
            Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
            ({{ filtered_count }} facture{{ filtered_count|pluralize }})
        </span>
        <nav>
            <ul class="pagination pagination-sm">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?q={{ q }}&devise={{ devise_filter }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&tri={{ tri }}&page={{ page_obj.previous_page_number }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                {% for num in page_obj.paginator.page_range %}
                    {% if num == page_obj.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num == 1 or num == page_obj.paginator.num_pages or num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                    <li class="page-item">
                        <a class="page-link" href="?q={{ q }}&devise={{ devise_filter }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&tri={{ tri }}&page={{ num }}">{{ num }}</a>
                    </li>
                    {% elif num == 2 or num == page_obj.paginator.num_pages|add:"-1" %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?q={{ q }}&devise={{ devise_filter }}&date_debut={{ date_debut }}&date_fin={{ date_fin }}&tri={{ tri }}&page={{ page_obj.next_page_number }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// =============================================
// RECHERCHE IA - FONCTIONS
// =============================================
function showIaSuggestions() {
    // Ne pas afficher si déjà visible ou si texte dans le champ
    var q = document.getElementById('q').value.trim();
    if (q.length === 0) {
        document.getElementById('iaSuggestions').classList.add('visible');
    }
}

function hideIaSuggestions() {
    document.getElementById('iaSuggestions').classList.remove('visible');
}

function toggleIaSuggestions() {
    var el = document.getElementById('iaSuggestions');
    el.classList.toggle('visible');
}

function applyIaSearch(type) {
    var today = new Date();
    var dateDebut = document.getElementById('date_debut');
    var dateFin = document.getElementById('date_fin');
    var triInput = document.querySelector('input[name="tri"]');
    var deviseSelect = document.getElementById('devise');
    
    // Reset
    dateDebut.value = '';
    dateFin.value = '';
    document.getElementById('q').value = '';
    
    function formatDate(d) {
        return d.toISOString().split('T')[0];
    }
    
    if (type === 'ce mois') {
        var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        var lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        dateDebut.value = formatDate(firstDay);
        dateFin.value = formatDate(lastDay);
    } else if (type === 'mois dernier') {
        var firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        var lastDay = new Date(today.getFullYear(), today.getMonth(), 0);
        dateDebut.value = formatDate(firstDay);
        dateFin.value = formatDate(lastDay);
    } else if (type === 'cette semaine') {
        var day = today.getDay();
        var diff = today.getDate() - day + (day === 0 ? -6 : 1);
        var monday = new Date(today.setDate(diff));
        today = new Date(); // Reset today
        dateDebut.value = formatDate(monday);
        dateFin.value = formatDate(today);
    } else if (type === 'gros montant') {
        triInput.value = '-montant_total';
    } else if (type === 'recentes') {
        triInput.value = '-date_facture';
    }
    
    hideIaSuggestions();
    document.getElementById('searchForm').submit();
}

document.addEventListener('DOMContentLoaded', function() {
    var qInput = document.getElementById('q');
    if (qInput) {
        // Focus + curseur à la FIN du texte
        qInput.focus();
        var len = qInput.value.length;
        qInput.setSelectionRange(len, len);
    }
    // Raccourci clavier: / pour focus recherche
    document.addEventListener('keydown', function(e) {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault();
            qInput.focus();
            qInput.select();
        }
        // Escape pour effacer la recherche ou fermer suggestions
        if (e.key === 'Escape') {
            hideIaSuggestions();
            if (document.activeElement.id === 'q') {
                qInput.value = '';
                document.getElementById('searchForm').submit();
            }
        }
    });
    
    // Fermer suggestions si clic ailleurs
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.ia-search-box')) {
            hideIaSuggestions();
        }
    });
});
</script>
{% endblock %}
